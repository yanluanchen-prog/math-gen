<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<title>æˆ‘æ˜¯æ•°å­¦å°å¤©æ‰ ğŸš€</title>
<style>
@import url('https://fonts.googleapis.com/css2?family=ZCOOL+KuaiLe&family=Nunito:wght@700;900&display=swap');
:root{
  --bg:#0a0e2a; --deep:#111740; --card:rgba(255,255,255,0.06);
  --border:rgba(255,255,255,0.12); --gold:#ffd700; --glow:rgba(255,215,0,0.3);
  --orange:#ff7b00; --green:#00d46a; --red:#ff4757; --blue:#1e90ff;
  --purple:#c77dff; --white:#e8eaf6; --dim:rgba(255,255,255,0.55);
  --cou-color:#1e90ff; --po-color:#ff7b00;
}
*{box-sizing:border-box;margin:0;padding:0;-webkit-tap-highlight-color:transparent}
body{font-family:'ZCOOL KuaiLe','Nunito',sans-serif;background:var(--bg);
  min-height:100vh;overflow:hidden;display:flex;align-items:center;justify-content:center}
#sf{position:fixed;inset:0;pointer-events:none;z-index:0}
.star{position:absolute;background:#fff;border-radius:50%;opacity:0;
  animation:twinkle var(--d) ease-in-out infinite}
@keyframes twinkle{0%,100%{opacity:0;transform:scale(.8)}50%{opacity:1;transform:scale(1.2)}}
#app{position:relative;z-index:1;width:min(480px,96vw);min-height:100vh;
  display:flex;flex-direction:column;align-items:center;justify-content:center;
  padding:14px;gap:10px}
.screen{display:none;width:100%}
.screen.active{display:flex;flex-direction:column;align-items:center;gap:12px}
.card{background:var(--card);border:1.5px solid var(--border);border-radius:22px;
  padding:18px 22px;width:100%;backdrop-filter:blur(12px);
  box-shadow:0 8px 32px rgba(0,0,0,.4)}
.T1{font-size:clamp(1.8rem,7vw,2.6rem);color:var(--gold);text-align:center;
  text-shadow:0 0 20px var(--glow),0 0 40px var(--glow);line-height:1.2}
.T2{font-size:clamp(.95rem,3.5vw,1.2rem);color:var(--white);text-align:center;opacity:.85}
.EB{font-size:clamp(2.5rem,10vw,4rem);text-align:center}
.btn{display:flex;align-items:center;justify-content:center;gap:8px;padding:15px 28px;
  border:none;border-radius:50px;cursor:pointer;font-family:inherit;font-size:1.2rem;
  font-weight:900;transition:transform .12s,box-shadow .12s;user-select:none;width:100%}
.btn:active{transform:scale(.95)!important}
.btn-p{background:linear-gradient(135deg,#ff7b00,#ff4500);color:#fff;
  box-shadow:0 6px 24px rgba(255,100,0,.5)}
.btn-p:hover{box-shadow:0 8px 32px rgba(255,100,0,.7);transform:translateY(-2px)}
.btn-s{background:linear-gradient(135deg,#6c3fa0,#4b2d7f);color:#fff;
  box-shadow:0 5px 18px rgba(108,63,160,.4)}
.btn-sm{padding:10px 20px;font-size:.95rem;width:auto;border-radius:50px}
.btn-ghost{background:rgba(255,255,255,.06);border:1.5px solid var(--border);
  color:var(--white);width:auto;padding:10px 18px;font-size:.9rem;border-radius:50px}
.divider{width:100%;height:1px;background:linear-gradient(90deg,transparent,var(--border),transparent)}

/* â”€â”€ Game tools row (timer + hint) â”€â”€ */
.game-tools{display:flex;align-items:center;justify-content:center;gap:12px;width:100%}
.hint-inline{display:none;white-space:nowrap;
  background:rgba(255,123,0,.22);
  border:2px solid rgba(255,123,0,.55);
  color:#ffd3aa;
  padding:10px 14px;border-radius:16px;
  font-family:inherit;font-size:1.02rem;font-weight:900;
  box-shadow:0 8px 26px rgba(255,123,0,.18);
  cursor:pointer;backdrop-filter:blur(10px);
}
.hint-inline.show{display:inline-flex}

/* â”€â”€ Screen scrolling â”€â”€ */
#screen-map.active,#screen-errorbook.active,#screen-parent.active,#screen-tutorial.active,#screen-game.active,#screen-result.active{
  overflow-y:auto;
  -webkit-overflow-scrolling:touch;
}

/* â”€â”€ HUD â”€â”€ */
#hud{display:flex;align-items:center;justify-content:space-between;width:100%;
  padding:10px 16px;background:rgba(255,255,255,.05);border:1.5px solid var(--border);
  border-radius:50px}
.hi{display:flex;align-items:center;gap:5px;font-size:.95rem;color:#fff}
.pw{width:100%;height:9px;background:rgba(255,255,255,.1);border-radius:50px;overflow:hidden}
#pb{height:100%;width:0;background:linear-gradient(90deg,#00d46a,#00ffaa);
  border-radius:50px;transition:width .4s cubic-bezier(.34,1.56,.64,1)}
/* â”€â”€ Timer â”€â”€ */
.tctr{position:relative;display:flex;align-items:center;justify-content:center;
  flex-direction:column}
#tsv{transform:rotate(-90deg)}
#tc{stroke:var(--orange);stroke-dasharray:125.6;stroke-dashoffset:0;
  transition:stroke-dashoffset 1s linear,stroke .3s}
#tt{position:absolute;font-size:1.2rem;font-weight:900;color:#fff;pointer-events:none}
/* â”€â”€ Question & Answer â”€â”€ */
#qd{font-size:clamp(2.2rem,10vw,3.5rem);color:#fff;text-align:center;
  letter-spacing:4px;text-shadow:0 0 20px rgba(255,255,255,.3);
  padding:18px;min-height:90px;display:flex;align-items:center;justify-content:center;
  transition:opacity .2s,transform .2s}
#ad{font-size:2.6rem;font-weight:900;color:var(--gold);text-align:center;
  min-height:66px;display:flex;align-items:center;justify-content:center;
  letter-spacing:6px;text-shadow:0 0 15px var(--glow)}
.blink{display:inline-block;width:3px;height:2.8rem;background:var(--gold);
  animation:blink 1s step-end infinite;vertical-align:middle;margin-left:4px;border-radius:2px}
@keyframes blink{50%{opacity:0}}
/* â”€â”€ Numpad â”€â”€ */
#np{display:grid;grid-template-columns:repeat(3,1fr);gap:9px;width:100%}
.nb{padding:16px;font-family:inherit;font-size:1.7rem;font-weight:900;color:#fff;
  background:rgba(255,255,255,.08);border:1.5px solid var(--border);border-radius:16px;
  cursor:pointer;transition:all .1s}
.nb:active,.nb.pr{background:rgba(255,215,0,.2);transform:scale(.92)}
.nb-del{background:rgba(255,71,87,.2);color:#ff8c96}
.nb-ok{background:linear-gradient(135deg,#00d46a,#00b359);
  box-shadow:0 4px 16px rgba(0,212,106,.4);font-size:1.4rem}
/* â”€â”€ Feedback â”€â”€ */
#fb{position:fixed;inset:0;z-index:100;display:flex;flex-direction:column;
  align-items:center;justify-content:center;gap:14px;pointer-events:none;
  opacity:0;transition:opacity .2s}
#fb.show{opacity:1;pointer-events:all}
#fb-bg{position:absolute;inset:0;background:rgba(0,0,0,.6)}
#fb-card{position:relative;z-index:1;background:var(--deep);border:3px solid var(--gold);
  border-radius:26px;padding:26px 32px;text-align:center;max-width:300px;
  box-shadow:0 0 40px rgba(255,215,0,.3)}
#fb-em{font-size:3.6rem}
#fb-msg{font-size:1.5rem;color:#fff;margin:9px 0 3px}
#fb-sub{font-size:.95rem;color:var(--dim)}
/* â”€â”€ Hint Modal â”€â”€ */
#hint-modal{position:fixed;inset:0;z-index:150;display:none;
  align-items:center;justify-content:center;padding:16px}
#hint-modal.show{display:flex}
#hint-bg{position:absolute;inset:0;background:rgba(0,0,0,.75)}
#hint-box{position:relative;z-index:1;background:#1a1f4a;border-radius:24px;
  padding:22px 20px;width:100%;max-width:400px;
  border:2px solid rgba(255,255,255,.15);box-shadow:0 12px 40px rgba(0,0,0,.6)}
.hm-badge{display:inline-flex;align-items:center;gap:6px;padding:6px 14px;
  border-radius:50px;font-size:.9rem;font-weight:900;margin-bottom:14px}
.hm-cou{background:rgba(30,144,255,.25);color:#6ab4ff;border:1px solid rgba(30,144,255,.4)}
.hm-po{background:rgba(255,123,0,.25);color:#ffb066;border:1px solid rgba(255,123,0,.4)}
.hint-steps{display:flex;flex-direction:column;gap:10px}
.hint-step{display:flex;align-items:center;gap:12px}
.hint-step-num{width:28px;height:28px;border-radius:50%;display:flex;
  align-items:center;justify-content:center;font-size:.85rem;font-weight:900;flex-shrink:0}
.hint-step-body{}
.hint-formula{font-size:1.4rem;color:var(--gold);font-weight:900;line-height:1.2}
.hint-explain{font-size:.82rem;color:var(--dim);margin-top:2px}
/* Ten-frame */
.tf-wrap{display:flex;flex-direction:column;align-items:center;gap:8px;width:100%}
.ten-frame{display:grid;grid-template-columns:repeat(5,1fr);gap:5px;
  background:rgba(255,255,255,.05);border-radius:12px;padding:8px;
  border:1.5px solid rgba(255,255,255,.1)}
.tf-dot{width:100%;aspect-ratio:1;border-radius:50%;border:2px solid rgba(255,255,255,.2);
  transition:all .4s cubic-bezier(.34,1.56,.64,1)}
.tf-dot.a{background:var(--cou-color);border-color:var(--cou-color);
  box-shadow:0 0 8px rgba(30,144,255,.5)}
.tf-dot.b{background:#ffd700;border-color:#ffd700;box-shadow:0 0 8px rgba(255,215,0,.5)}
.tf-dot.moved{background:var(--green);border-color:var(--green);
  box-shadow:0 0 8px rgba(0,212,106,.6)}
.tf-dot.hi{border-color:#fff;border-width:3px;background:rgba(255,255,255,.1);
  box-shadow:0 0 10px rgba(255,255,255,.4)}
.tf-dot.full{background:linear-gradient(135deg,var(--cou-color),var(--green));
  border-color:var(--green)}
.extra-dots{display:flex;flex-wrap:wrap;gap:5px;justify-content:center}
.ed{width:32px;height:32px;border-radius:50%;transition:all .3s}
.ed.b{background:#ffd700;box-shadow:0 0 6px rgba(255,215,0,.5)}
.ed.hi{background:#ff7b00;box-shadow:0 0 8px rgba(255,123,0,.6)}
.ed.empty{background:transparent;border:2px solid rgba(255,255,255,.15)}
/* Number tree for ç ´åæ³• */
.num-tree{display:flex;flex-direction:column;align-items:center;gap:0;width:100%}
.nt-row{display:flex;align-items:center;justify-content:center;gap:16px}
.nt-node{min-width:60px;padding:10px 14px;border-radius:14px;text-align:center;
  font-size:1.5rem;font-weight:900;transition:all .4s}
.nt-node.main{background:rgba(255,123,0,.2);color:#ff9f45;border:2px solid rgba(255,123,0,.5)}
.nt-node.ten{background:rgba(255,71,87,.2);color:#ff8c96;border:2px solid rgba(255,71,87,.4)}
.nt-node.units{background:rgba(30,144,255,.2);color:#6ab4ff;border:2px solid rgba(30,144,255,.4)}
.nt-node.result{background:rgba(0,212,106,.2);color:#00d46a;border:2px solid rgba(0,212,106,.4)}
.nt-node.dim{opacity:.3}
.nt-branches{display:flex;justify-content:center;gap:40px;position:relative}
.nt-branches::before{content:'';position:absolute;top:0;left:50%;transform:translateX(-50%);
  width:60%;height:1.5px;background:rgba(255,255,255,.2)}
.nt-vline{width:1.5px;height:16px;background:rgba(255,255,255,.2);margin:0 auto}
.nt-eq{font-size:.9rem;color:var(--dim);margin:4px 0}
.nt-final{font-size:1.8rem;font-weight:900;color:var(--gold);text-align:center;
  text-shadow:0 0 15px var(--glow)}
/* â”€â”€ Tutorial â”€â”€ */
.tut-badge{display:inline-flex;align-items:center;gap:6px;padding:8px 18px;
  border-radius:50px;font-size:1rem;font-weight:900;align-self:flex-start}
.tut-badge.cou{background:rgba(30,144,255,.2);color:#6ab4ff;border:1.5px solid rgba(30,144,255,.4)}
.tut-badge.po{background:rgba(255,123,0,.2);color:#ffb066;border:1.5px solid rgba(255,123,0,.4)}
.step-dots{display:flex;gap:7px;justify-content:center}
.sd{width:8px;height:8px;border-radius:50%;background:rgba(255,255,255,.2);transition:all .3s}
.sd.on{background:var(--gold);box-shadow:0 0 6px var(--glow);width:22px;border-radius:4px}
.tut-title{font-size:1.4rem;font-weight:900;color:#fff;text-align:center}
.tut-desc{font-size:.95rem;color:var(--dim);text-align:center;margin-top:6px;line-height:1.6}
.tut-nav{display:flex;gap:10px;width:100%}
.tut-nav .btn-s{flex:1}
.tut-nav .btn-p{flex:2}
/* â”€â”€ Particles â”€â”€ */
.particle{position:fixed;pointer-events:none;z-index:200;font-size:1.3rem;
  animation:pfly var(--d) ease-out forwards}
@keyframes pfly{0%{transform:translateY(0) scale(1);opacity:1}
  100%{transform:translateY(-110px) scale(.3) rotate(360deg);opacity:0}}
/* â”€â”€ Streak â”€â”€ */
#streak{position:fixed;top:14px;right:14px;z-index:50;
  background:linear-gradient(135deg,#ff7b00,#ff4500);color:#fff;border-radius:50px;
  padding:7px 14px;font-size:.95rem;font-weight:900;
  box-shadow:0 4px 14px rgba(255,100,0,.5);transform:scale(0);
  transition:transform .3s cubic-bezier(.34,1.56,.64,1)}
#streak.show{transform:scale(1)}
/* â”€â”€ Celebration â”€â”€ */
#cel{position:fixed;inset:0;z-index:300;display:none;align-items:center;
  justify-content:center;flex-direction:column;gap:18px;
  background:radial-gradient(ellipse,rgba(108,63,160,.92),rgba(10,14,42,.98))}
#cel.show{display:flex}
.cel-t{font-size:clamp(1.8rem,7vw,3rem);color:var(--gold);text-align:center;
  text-shadow:0 0 30px var(--glow)}
.confetti{position:fixed;width:10px;height:10px;border-radius:2px;
  animation:cfall var(--d) ease-in forwards}
@keyframes cfall{0%{transform:translateY(-10px) rotate(0);opacity:1}
  100%{transform:translateY(100vh) rotate(720deg);opacity:0}}
/* â”€â”€ Space Map â”€â”€ */
#screen-map{min-height:100vh;}
#screen-map.active{display:flex; padding-bottom:80px;}
.space-map-wrap{
  position:relative;
  width:100%;
  flex:1;
  height:calc(100vh - 230px);
  min-height:520px;
  overflow:hidden;
  border-radius:0;
  background:transparent;
  border:none;
  box-shadow:none;
}
/* mini stars inside map */
.map-star{position:absolute;background:#fff;border-radius:50%;pointer-events:none;
  animation:twinkle var(--d) ease-in-out infinite}
/* SVG flight path */
.map-svg{position:absolute;inset:0;width:100%;height:100%;pointer-events:none;overflow:visible}
/* Planet node */
.planet-node{
  position:absolute;
  display:flex;flex-direction:column;align-items:center;
  transform:translate(-50%,-50%);
  cursor:pointer;
  transition:filter .2s;
  z-index:2;
}
.planet-node.locked{opacity:.35;cursor:not-allowed;filter:grayscale(.7)}
.planet-node.accessible:hover .planet-body{transform:scale(1.12);}
.planet-node.accessible:active .planet-body{transform:scale(.94);}
.planet-body{
  border-radius:50%;
  overflow:hidden;
  display:flex;align-items:center;justify-content:center;
  border:3px solid rgba(255,255,255,.15);
  position:relative;
  transition:transform .18s cubic-bezier(.34,1.56,.64,1),box-shadow .2s;
  will-change:transform;
}



/* planet svg icons */
.planet-surface{position:absolute;inset:8px;border-radius:50%;
  z-index:1;
  background-color:rgba(255,255,255,.08);
  background-size:cover;background-position:center;
  box-shadow:inset -12px -14px 26px rgba(0,0,0,.32), inset 10px 10px 18px rgba(255,255,255,.12), 0 10px 22px rgba(0,0,0,.28);
}
.planet-has-ring .planet-ring{opacity:1}
.planet-ring{opacity:.0; position:absolute;inset:-12px;border-radius:50%;border:5px solid rgba(255,255,255,.20);
  z-index:2;
  transform:rotate(-18deg);
  clip-path:polygon(0 46%,100% 34%,100% 62%,0 74%);
  pointer-events:none;
}

.planet-skin-0{background-image:url('data:image/svg+xml,%3Csvg%20xmlns%3D%27http%3A//www.w3.org/2000/svg%27%20viewBox%3D%270%200%20200%20200%27%3E%0A%3Cdefs%3E%0A%3CradialGradient%20id%3D%27g%27%20cx%3D%2735%25%27%20cy%3D%2730%25%27%3E%0A%3Cstop%20offset%3D%270%25%27%20stop-color%3D%27%23ffd0c2%27/%3E%0A%3Cstop%20offset%3D%2755%25%27%20stop-color%3D%27%23ff8d7a%27/%3E%0A%3Cstop%20offset%3D%27100%25%27%20stop-color%3D%27%23d84a3a%27/%3E%0A%3C/radialGradient%3E%0A%3C/defs%3E%0A%3Ccircle%20cx%3D%27100%27%20cy%3D%27100%27%20r%3D%2786%27%20fill%3D%27url%28%23g%29%27/%3E%0A%3Ccircle%20cx%3D%2770%27%20cy%3D%2775%27%20r%3D%2710%27%20fill%3D%27rgba%280%2C0%2C0%2C.10%29%27/%3E%0A%3Ccircle%20cx%3D%27120%27%20cy%3D%27120%27%20r%3D%2714%27%20fill%3D%27rgba%280%2C0%2C0%2C.08%29%27/%3E%0A%3Ccircle%20cx%3D%27130%27%20cy%3D%2780%27%20r%3D%278%27%20fill%3D%27rgba%28255%2C255%2C255%2C.20%29%27/%3E%0A%3C/svg%3E');}
.planet-skin-1{background-image:url('data:image/svg+xml,%3Csvg%20xmlns%3D%27http%3A//www.w3.org/2000/svg%27%20viewBox%3D%270%200%20200%20200%27%3E%0A%3Cdefs%3E%3CradialGradient%20id%3D%27g%27%20cx%3D%2735%25%27%20cy%3D%2730%25%27%3E%0A%3Cstop%20offset%3D%270%25%27%20stop-color%3D%27%23fff2d8%27/%3E%3Cstop%20offset%3D%2755%25%27%20stop-color%3D%27%23ffd3a1%27/%3E%3Cstop%20offset%3D%27100%25%27%20stop-color%3D%27%23ff9f43%27/%3E%3C/radialGradient%3E%3C/defs%3E%0A%3Ccircle%20cx%3D%27100%27%20cy%3D%27100%27%20r%3D%2786%27%20fill%3D%27url%28%23g%29%27/%3E%0A%3Cg%20opacity%3D%27.35%27%3E%0A%3Cpath%20d%3D%27M25%2070c45%2020%20105-20%20150%200%27%20stroke%3D%27%23fff%27%20stroke-width%3D%2710%27%20stroke-linecap%3D%27round%27/%3E%0A%3Cpath%20d%3D%27M20%2095c55%2018%20115-18%20160%200%27%20stroke%3D%27%23fff%27%20stroke-width%3D%278%27%20stroke-linecap%3D%27round%27/%3E%0A%3Cpath%20d%3D%27M25%20120c50%2016%20110-16%20150%200%27%20stroke%3D%27%23fff%27%20stroke-width%3D%279%27%20stroke-linecap%3D%27round%27/%3E%0A%3C/g%3E%0A%3C/svg%3E');}
.planet-skin-2{background-image:url('data:image/svg+xml,%3Csvg%20xmlns%3D%27http%3A//www.w3.org/2000/svg%27%20viewBox%3D%270%200%20200%20200%27%3E%0A%3Cdefs%3E%3CradialGradient%20id%3D%27g%27%20cx%3D%2735%25%27%20cy%3D%2730%25%27%3E%0A%3Cstop%20offset%3D%270%25%27%20stop-color%3D%27%23fff8dd%27/%3E%3Cstop%20offset%3D%2760%25%27%20stop-color%3D%27%23f7d060%27/%3E%3Cstop%20offset%3D%27100%25%27%20stop-color%3D%27%23c9a227%27/%3E%3C/radialGradient%3E%3C/defs%3E%0A%3Ccircle%20cx%3D%27100%27%20cy%3D%27100%27%20r%3D%2774%27%20fill%3D%27url%28%23g%29%27/%3E%0A%3Cg%20opacity%3D%27.65%27%3E%0A%3Cellipse%20cx%3D%27100%27%20cy%3D%27110%27%20rx%3D%27120%27%20ry%3D%2742%27%20fill%3D%27none%27%20stroke%3D%27rgba%28255%2C255%2C255%2C.55%29%27%20stroke-width%3D%2712%27/%3E%0A%3Cellipse%20cx%3D%27100%27%20cy%3D%27110%27%20rx%3D%27120%27%20ry%3D%2742%27%20fill%3D%27none%27%20stroke%3D%27rgba%280%2C0%2C0%2C.10%29%27%20stroke-width%3D%273%27/%3E%0A%3C/g%3E%0A%3C/svg%3E');}
.planet-skin-3{background-image:url('data:image/svg+xml,%3Csvg%20xmlns%3D%27http%3A//www.w3.org/2000/svg%27%20viewBox%3D%270%200%20200%20200%27%3E%0A%3Cdefs%3E%3CradialGradient%20id%3D%27g%27%20cx%3D%2735%25%27%20cy%3D%2730%25%27%3E%0A%3Cstop%20offset%3D%270%25%27%20stop-color%3D%27%23e8f8ff%27/%3E%3Cstop%20offset%3D%2755%25%27%20stop-color%3D%27%23bfe8ff%27/%3E%3Cstop%20offset%3D%27100%25%27%20stop-color%3D%27%234fa3e3%27/%3E%3C/radialGradient%3E%3C/defs%3E%0A%3Ccircle%20cx%3D%27100%27%20cy%3D%27100%27%20r%3D%2780%27%20fill%3D%27url%28%23g%29%27/%3E%0A%3Cg%20opacity%3D%27.25%27%3E%0A%3Cpath%20d%3D%27M30%2085c40%2015%20100-15%20140%200%27%20stroke%3D%27%23fff%27%20stroke-width%3D%278%27%20stroke-linecap%3D%27round%27/%3E%0A%3Cpath%20d%3D%27M28%20110c45%2014%20105-14%20144%200%27%20stroke%3D%27%23fff%27%20stroke-width%3D%277%27%20stroke-linecap%3D%27round%27/%3E%0A%3C/g%3E%0A%3C/svg%3E');}
.planet-skin-4{background-image:url('data:image/svg+xml,%3Csvg%20xmlns%3D%27http%3A//www.w3.org/2000/svg%27%20viewBox%3D%270%200%20200%20200%27%3E%0A%3Cdefs%3E%3CradialGradient%20id%3D%27g%27%20cx%3D%2735%25%27%20cy%3D%2730%25%27%3E%0A%3Cstop%20offset%3D%270%25%27%20stop-color%3D%27%23ffffff%27/%3E%3Cstop%20offset%3D%2735%25%27%20stop-color%3D%27%23ead9ff%27/%3E%3Cstop%20offset%3D%27100%25%27%20stop-color%3D%27%23b48cff%27/%3E%3C/radialGradient%3E%3C/defs%3E%0A%3Ccircle%20cx%3D%27100%27%20cy%3D%27100%27%20r%3D%2784%27%20fill%3D%27url%28%23g%29%27/%3E%0A%3Cg%20opacity%3D%27.35%27%3E%0A%3Ccircle%20cx%3D%2770%27%20cy%3D%2785%27%20r%3D%2712%27%20fill%3D%27rgba%28255%2C255%2C255%2C.55%29%27/%3E%0A%3Ccircle%20cx%3D%27135%27%20cy%3D%27120%27%20r%3D%279%27%20fill%3D%27rgba%28255%2C255%2C255%2C.45%29%27/%3E%0A%3C/g%3E%0A%3C/svg%3E');}
.planet-skin-cou{background-image:url('data:image/svg+xml;base64,PHN2ZyB4bWxucz0naHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmcnIHZpZXdCb3g9JzAgMCAyMDAgMjAwJz4KPGRlZnM+CiAgPHJhZGlhbEdyYWRpZW50IGlkPSdwZycgY3g9JzMyJScgY3k9JzI4JSc+CiAgICA8c3RvcCBvZmZzZXQ9JzAlJyBzdG9wLWNvbG9yPScjZmZmOGYyJy8+CiAgICA8c3RvcCBvZmZzZXQ9JzU1JScgc3RvcC1jb2xvcj0nI2YyZGNjZCcvPgogICAgPHN0b3Agb2Zmc2V0PScxMDAlJyBzdG9wLWNvbG9yPScjZDhiZmFlJy8+CiAgPC9yYWRpYWxHcmFkaWVudD4KPC9kZWZzPgo8Y2lyY2xlIGN4PScxMDAnIGN5PScxMDAnIHI9Jzc4JyBmaWxsPSd1cmwoI3BnKScvPgo8ZyBvcGFjaXR5PScuMzUnPgogIDxwYXRoIGQ9J001MCA3MmM0MC0xOCA2MC0xOCAxMDAgMCcgc3Ryb2tlPScjZmZmZmZmJyBzdHJva2Utd2lkdGg9JzcnIHN0cm9rZS1saW5lY2FwPSdyb3VuZCcvPgogIDxwYXRoIGQ9J000NSA5NWM0NS0xNiA2NS0xNiAxMTAgMCcgc3Ryb2tlPScjZmZmZmZmJyBzdHJva2Utd2lkdGg9JzYnIHN0cm9rZS1saW5lY2FwPSdyb3VuZCcvPgo8L2c+CjxnIG9wYWNpdHk9Jy44NSc+CiAgPGVsbGlwc2UgY3g9JzEwMCcgY3k9JzExMicgcng9JzExOCcgcnk9JzQ0JyBmaWxsPSdub25lJyBzdHJva2U9J3JnYmEoMjU1LDI1NSwyNTUsLjc1KScgc3Ryb2tlLXdpZHRoPScxNCcvPgogIDxlbGxpcHNlIGN4PScxMDAnIGN5PScxMTInIHJ4PScxMTgnIHJ5PSc0NCcgZmlsbD0nbm9uZScgc3Ryb2tlPSdyZ2JhKDAsMCwwLC4xMCknIHN0cm9rZS13aWR0aD0nNCcvPgo8L2c+Cjwvc3ZnPg==');}
.planet-skin-po{background-image:url('data:image/svg+xml;base64,PHN2ZyB4bWxucz0naHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmcnIHZpZXdCb3g9JzAgMCAyMDAgMjAwJz4KPGRlZnM+CiAgPHJhZGlhbEdyYWRpZW50IGlkPSd0ZycgY3g9JzM1JScgY3k9JzMwJSc+CiAgICA8c3RvcCBvZmZzZXQ9JzAlJyBzdG9wLWNvbG9yPScjZWVmY2ZmJy8+CiAgICA8c3RvcCBvZmZzZXQ9JzU1JScgc3RvcC1jb2xvcj0nI2JkZWZmMCcvPgogICAgPHN0b3Agb2Zmc2V0PScxMDAlJyBzdG9wLWNvbG9yPScjNmZjN2M5Jy8+CiAgPC9yYWRpYWxHcmFkaWVudD4KPC9kZWZzPgo8Y2lyY2xlIGN4PScxMDAnIGN5PScxMDAnIHI9Jzg0JyBmaWxsPSd1cmwoI3RnKScvPgo8ZyBvcGFjaXR5PScuMzUnPgogIDxwYXRoIGQ9J00zNSA4NmMzOCAxOCA5Mi0xOCAxMzAgMCcgc3Ryb2tlPSdyZ2JhKDI1NSwyNTUsMjU1LC42NSknIHN0cm9rZS13aWR0aD0nOScgc3Ryb2tlLWxpbmVjYXA9J3JvdW5kJy8+CiAgPHBhdGggZD0nTTQwIDExMmMzMCAxNiA5MC0xNiAxMjAgMCcgc3Ryb2tlPSdyZ2JhKDI1NSwyNTUsMjU1LC40NSknIHN0cm9rZS13aWR0aD0nOCcgc3Ryb2tlLWxpbmVjYXA9J3JvdW5kJy8+CiAgPGNpcmNsZSBjeD0nMTMyJyBjeT0nNzInIHI9JzknIGZpbGw9J3JnYmEoMjU1LDI1NSwyNTUsLjM1KScvPgo8L2c+Cjwvc3ZnPg==');}

.planet-ring{position:absolute;inset:-10px;border-radius:50%;border:4px solid rgba(255,255,255,.18);
  transform:rotate(-18deg);
  clip-path:polygon(0 46%,100% 34%,100% 62%,0 74%);
  filter:drop-shadow(0 0 8px rgba(255,255,255,.08));
  pointer-events:none;
}

.planet-body::after{
  content:'';
  position:absolute;
  inset:-10px;
  border-radius:50%;
  border:3px solid rgba(255,255,255,.10);
  transform:rotate(-18deg);
  clip-path:polygon(0 46%,100% 34%,100% 62%,0 74%);
  pointer-events:none;
}
/* glow ring pulse for accessible-not-done planets */
.planet-body.pulse-glow{
  animation:float var(--fd) ease-in-out infinite, glow-pulse 2.4s ease-in-out infinite;
}
.planet-body.float-only{animation:float var(--fd) ease-in-out infinite;}
@keyframes float{
  0%,100%{transform:translateY(0)}
  50%{transform:translateY(-8px)}
}
@keyframes glow-pulse{
  0%,100%{box-shadow:var(--glow-base),0 0 0 0 var(--glow-color)}
  50%{box-shadow:var(--glow-base),0 0 0 8px transparent}
}
.planet-em{font-size:2rem;line-height:1;pointer-events:none;user-select:none}
.planet-name{
  margin-top:6px;font-size:.75rem;font-weight:900;color:#fff;
  text-align:center;white-space:nowrap;
  text-shadow:0 1px 6px rgba(0,0,0,.8);pointer-events:none;
}
.planet-stars{font-size:.72rem;letter-spacing:-2px;line-height:1;margin-top:2px;pointer-events:none}
.planet-lock-icon{
  position:absolute;bottom:-4px;right:-4px;
  background:#0a0e2a;border:1.5px solid rgba(255,255,255,.2);
  border-radius:50%;width:22px;height:22px;
  display:flex;align-items:center;justify-content:center;font-size:.7rem;
}
/* Tutorial node (book) */
.tut-node{
  position:absolute;transform:translate(-50%,-50%);
  display:flex;flex-direction:column;align-items:center;
  cursor:pointer;z-index:2;
  transition:filter .2s;
}
.tut-node.locked{opacity:.3;cursor:not-allowed;filter:grayscale(.8)}
.tut-node.accessible:hover .tut-body{transform:scale(1.12) rotate(5deg);}
.tut-body{
  width:52px;height:52px;border-radius:14px;
  display:flex;align-items:center;justify-content:center;
  font-size:1.5rem;border:2.5px solid transparent;
  transition:transform .18s cubic-bezier(.34,1.56,.64,1);
  position:relative;
}
.tut-body.cou-tut{
  background:rgba(30,144,255,.2);border-color:rgba(30,144,255,.6);
  box-shadow:0 0 18px rgba(30,144,255,.3);
  animation:float var(--fd) ease-in-out infinite, tut-pulse 2.8s ease-in-out infinite;
}
.tut-body.po-tut{
  background:rgba(255,123,0,.2);border-color:rgba(255,123,0,.6);
  box-shadow:0 0 18px rgba(255,123,0,.3);
  animation:float var(--fd) ease-in-out infinite, tut-pulse 3s ease-in-out infinite;
}
.tut-body.done-tut{
  background:rgba(0,212,106,.15);border-color:rgba(0,212,106,.5);
  box-shadow:0 0 14px rgba(0,212,106,.25);
  animation:float var(--fd) ease-in-out infinite;
}
@keyframes tut-pulse{
  0%,100%{box-shadow:0 0 18px var(--tp,rgba(30,144,255,.3))}
  50%{box-shadow:0 0 30px var(--tp,rgba(30,144,255,.6)),0 0 50px var(--tp,rgba(30,144,255,.2))}
}
.tut-label{
  margin-top:5px;font-size:.68rem;font-weight:900;
  padding:2px 7px;border-radius:50px;text-align:center;white-space:nowrap;
  text-shadow:0 1px 4px rgba(0,0,0,.8);pointer-events:none;
}
.tut-label.req{color:var(--gold);background:rgba(0,0,0,.5)}
.tut-label.done{color:#00d46a;background:rgba(0,0,0,.5)}
.tut-label.lk{color:rgba(255,255,255,.4);background:rgba(0,0,0,.4)}
/* â”€â”€ Result â”€â”€ */
.stars-row{display:flex;gap:10px;justify-content:center;font-size:2.8rem}
.r-stats{display:grid;grid-template-columns:1fr 1fr;gap:9px;width:100%}
.r-box{background:rgba(255,255,255,.05);border-radius:14px;padding:12px;text-align:center}
.r-num{font-size:1.9rem;color:var(--gold);font-weight:900}
.r-lbl{font-size:.8rem;color:var(--dim);margin-top:3px}
/* â”€â”€ Error Book â”€â”€ */
.err-list{display:flex;flex-direction:column;gap:8px;width:100%;
  max-height:45vh;overflow-y:auto;padding-right:4px}
.err-list::-webkit-scrollbar{width:4px}
.err-list::-webkit-scrollbar-thumb{background:rgba(255,255,255,.2);border-radius:2px}
.err-item{display:flex;align-items:center;gap:10px;padding:12px 14px;
  background:rgba(255,255,255,.04);border-radius:14px;border:1px solid var(--border)}
.ei-q{flex:1;font-size:1.1rem;color:#fff}
.ei-ans{font-size:.82rem;padding:4px 10px;border-radius:50px;
  background:rgba(255,71,87,.2);color:#ff8c96}
.ei-lv{font-size:.72rem;color:var(--dim)}
.err-empty{text-align:center;padding:30px;color:var(--dim);font-size:1rem}
/* â”€â”€ Parent Panel â”€â”€ */
.tab-row{display:flex;gap:6px;width:100%}
.tab{flex:1;padding:10px;border-radius:12px;border:none;cursor:pointer;
  font-family:inherit;font-size:.85rem;font-weight:700;
  background:rgba(255,255,255,.05);color:var(--dim);transition:all .2s}
.tab.on{background:rgba(255,215,0,.15);color:var(--gold);
  border:1px solid rgba(255,215,0,.3)}
.p-section{display:none;width:100%}
.p-section.on{display:flex;flex-direction:column;gap:10px}
.p-stat-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:8px;width:100%}
.p-stat{background:rgba(255,255,255,.05);border-radius:14px;padding:12px;text-align:center}
.p-stat-n{font-size:1.6rem;font-weight:900;color:var(--gold)}
.p-stat-l{font-size:.72rem;color:var(--dim);margin-top:3px}
.p-bar-row{display:flex;align-items:center;gap:8px;margin-bottom:6px}
.p-bar-lbl{width:70px;font-size:.8rem;color:var(--dim);text-align:right}
.p-bar-track{flex:1;height:10px;background:rgba(255,255,255,.08);border-radius:5px;overflow:hidden}
.p-bar-fill{height:100%;background:linear-gradient(90deg,var(--blue),var(--green));
  border-radius:5px;transition:width .6s cubic-bezier(.34,1.56,.64,1)}
.p-bar-val{width:36px;font-size:.8rem;color:#fff;text-align:left}
.p-session{display:flex;align-items:center;justify-content:space-between;
  padding:10px 12px;background:rgba(255,255,255,.04);border-radius:12px;
  border:1px solid var(--border);margin-bottom:6px}
.ps-lv{font-size:.9rem;color:#fff}
.ps-acc{font-size:.85rem;color:var(--green)}
.ps-date{font-size:.72rem;color:var(--dim)}
/* â”€â”€ Voice toggle â”€â”€ */
#voice-btn{position:fixed;top:14px;left:14px;z-index:50;
  background:rgba(255,255,255,.1);border:1.5px solid var(--border);
  border-radius:50%;width:40px;height:40px;display:flex;align-items:center;
  justify-content:center;cursor:pointer;font-size:1.1rem;transition:all .2s}
#voice-btn.off{opacity:.4}
/* â”€â”€ Shakes â”€â”€ */
.shake{animation:shake .4s cubic-bezier(.36,.07,.19,.97)}
@keyframes shake{10%,90%{transform:translateX(-4px)}20%,80%{transform:translateX(6px)}
  30%,50%,70%{transform:translateX(-8px)}40%,60%{transform:translateX(8px)}}
.pulse{animation:pulse .3s cubic-bezier(.34,1.56,.64,1)}
@keyframes pulse{50%{transform:scale(1.15)}}
.fade-in{animation:fi .3s ease}
@keyframes fi{from{opacity:0;transform:translateY(8px)}to{opacity:1;transform:none}}
</style>
</head>
<body>
<div id="sf"></div>
<div id="voice-btn" onclick="toggleVoice()" title="æœ—è¯»å¼€å…³">ğŸ—£ï¸</div>
<div id="bgm-btn" onclick="toggleBgm()" title="èƒŒæ™¯éŸ³ä¹" style="position:fixed;top:14px;left:62px;z-index:50;background:rgba(255,255,255,.1);border:1.5px solid var(--border);border-radius:50%;width:40px;height:40px;display:flex;align-items:center;justify-content:center;cursor:pointer;font-size:1.1rem;transition:all .2s">ğŸµ</div>
<div id="streak">ğŸ”¥ è¿å‡» <span id="sk-n">2</span>ï¼</div>

<div id="app">

<!-- HOME -->
<div id="screen-home" class="screen active">
  <div class="EB">ğŸš€</div>
  <div class="T1">æˆ‘æ˜¯æ•°å­¦å°å¤©æ‰</div>
  <div class="T2">å¾æœæ•°å­¦å®‡å®™ä¸­çš„æ•°å­¦æ˜Ÿçƒï¼</div>
  <div class="card" style="padding:12px 18px;text-align:center">
    <div style="font-size:.9rem;color:var(--dim);line-height:2">
      ğŸŒŸ ç­”å¯¹é¢˜ç›®æ”¶é›†æ˜Ÿæ˜Ÿ &nbsp; ğŸª é—¯è¿‡7ä¸ªæ•°å­¦æ˜Ÿçƒ<br>
      ğŸ”µ å­¦ä¼šå‡‘åæ³• &nbsp; ğŸŸ  æŒæ¡ç ´åæ³• &nbsp; ğŸ† æˆä¸ºæ•°å­¦å®‡èˆªå‘˜ï¼
    </div>
  </div>
  <button class="btn btn-p" onclick="showScreen('map')">ğŸš€ å¼€å§‹å†’é™©ï¼</button>
  <div style="display:flex;gap:8px;width:100%">
    <button class="btn btn-ghost" onclick="showScreen('errorbook')">ğŸ“’ é”™é¢˜æœ¬</button>
    <button class="btn btn-ghost" onclick="showScreen('parent')">ğŸ‘¨â€ğŸ‘©â€ğŸ‘§ å®¶é•¿</button>
  </div>
  <button class="btn btn-ghost" style="opacity:.5;font-size:.85rem" onclick="if(confirm('ç¡®å®šé‡æ–°å¼€å§‹å—ï¼Ÿæ‰€æœ‰æ˜Ÿæ˜Ÿå’Œè®°å½•éƒ½ä¼šæ¸…ç©º'))resetAll()">ğŸ”„ é‡ç½®æ•°æ®</button>
</div>

<!-- MAP -->
<div id="screen-map" class="screen">
  <div style="display:flex;justify-content:space-between;align-items:center;width:100%">
    <div class="T1" style="font-size:1.7rem">ğŸŒŒ</div>
    <div style="color:var(--gold);font-size:1.1rem;font-weight:900">â­ <span id="map-total">0</span></div>
  </div>
  <div class="T2" style="font-size:.82rem;opacity:.55;align-self:flex-start"></div>
  <div class="space-map-wrap" id="space-map-wrap"></div>
  <div class="divider"></div>
  <button class="btn btn-ghost btn-sm" onclick="showScreen('home')">â† è¿”å›é¦–é¡µ</button>
</div>

<!-- TUTORIAL (å‡‘åæ³• & ç ´åæ³• å…±ç”¨) -->
<div id="screen-tutorial" class="screen">
  <div id="tut-badge-el" class="tut-badge cou">ğŸ”µ å‡‘åæ³•</div>
  <!-- Fixed question banner â€” always visible -->
  <div id="tut-question-banner" style="
    width:100%;text-align:center;
    background:rgba(255,215,0,.12);
    border:2px solid rgba(255,215,0,.35);
    border-radius:18px;padding:10px 16px;
    font-size:1.9rem;font-weight:900;color:#fff;
    letter-spacing:4px;text-shadow:0 0 16px rgba(255,215,0,.4)
  ">8 + 5 = ï¼Ÿ</div>
  <div class="step-dots" id="tut-dots"></div>
  <div class="card" id="tut-visual" style="padding:14px;overflow:hidden"></div>
  <div class="card" style="text-align:center;padding:12px 16px">
    <div class="tut-title" id="tut-title">æ ‡é¢˜</div>
    <div class="tut-desc" id="tut-desc"></div>
  </div>
  <div class="tut-nav" id="tut-nav-row">
    <button class="btn btn-s btn-sm" id="tut-prev" onclick="tutNav(-1)">â† ä¸Šä¸€æ­¥</button>
    <button class="btn btn-p" id="tut-next" onclick="tutNav(1)">ä¸‹ä¸€æ­¥ â†’</button>
  </div>
  <button class="btn btn-ghost btn-sm" onclick="completeTutorial(tutType);showScreen('map')">å·²ç»ä¼šäº†ï¼Œå»é—¯å…³ â†’</button>
</div>

<!-- GAME -->
<div id="screen-game" class="screen">
  <div id="hud">
    <div class="hi">ğŸª <span id="h-lv">ç¬¬1å…³</span></div>
    <div class="hi" style="color:var(--gold)">â­ <span id="h-st">0</span></div>
    <div class="hi">ğŸ“ <span id="h-q">1</span>/10</div>
  </div>
  <div class="pw"><div id="pb"></div></div>
  <div class="card" style="padding:6px 20px">
    <div id="qd">?</div>
    <div class="divider"></div>
    <div id="ad"><span id="at"></span><span class="blink"></span></div>
  </div>
  <div class="game-tools">
    <div class="tctr">
      <svg id="tsv" width="68" height="68" viewBox="0 0 68 68">
        <circle cx="34" cy="34" r="20" fill="none" stroke="rgba(255,255,255,.1)" stroke-width="5"/>
        <circle id="tc" cx="34" cy="34" r="20" fill="none" stroke-width="5" stroke-linecap="round"/>
      </svg>
      <div id="tt">15</div>
    </div>

    <button id="hint-btn" class="hint-inline" onclick="showHint()" type="button">ğŸš¨ ä¸ä¼šåšï¼Ÿçœ‹è¿™é‡Œï¼</button>
  </div>
  <div id="np">
    <button class="nb" onclick="ni('7')">7</button>
    <button class="nb" onclick="ni('8')">8</button>
    <button class="nb" onclick="ni('9')">9</button>
    <button class="nb" onclick="ni('4')">4</button>
    <button class="nb" onclick="ni('5')">5</button>
    <button class="nb" onclick="ni('6')">6</button>
    <button class="nb" onclick="ni('1')">1</button>
    <button class="nb" onclick="ni('2')">2</button>
    <button class="nb" onclick="ni('3')">3</button>
    <button class="nb nb-del" onclick="nd()">âŒ«</button>
    <button class="nb" onclick="ni('0')">0</button>
    <button class="nb nb-ok" onclick="submit()">âœ“</button>
  </div>
</div>

<!-- RESULT -->
<div id="screen-result" class="screen">
  <div id="res-em" class="EB">ğŸ‰</div>
  <div id="res-title" class="T1" style="font-size:1.9rem">é€šå…³ï¼</div>
  <div class="stars-row" id="res-stars"></div>
  <div class="r-stats">
    <div class="r-box"><div class="r-num" id="rr-cor">0</div><div class="r-lbl">âœ… ç­”å¯¹é¢˜æ•°</div></div>
    <div class="r-box"><div class="r-num" id="rr-st">0</div><div class="r-lbl">â­ è·å¾—æ˜Ÿæ˜Ÿ</div></div>
    <div class="r-box"><div class="r-num" id="rr-sk">0</div><div class="r-lbl">ğŸ”¥ æœ€é•¿è¿å‡»</div></div>
    <div class="r-box"><div class="r-num" id="rr-t">0s</div><div class="r-lbl">â± ç”¨æ—¶</div></div>
  </div>
  <div id="res-msg" class="T2" style="font-size:.9rem"></div>
  <button class="btn btn-p" id="res-next" onclick="nextLevel()">ä¸‹ä¸€å…³ â†’</button>
  <button class="btn btn-s" onclick="retryLevel()">ğŸ” å†æŒ‘æˆ˜ä¸€æ¬¡</button>
  <button class="btn btn-ghost btn-sm" onclick="showScreen('map')">ğŸ—º è¿”å›åœ°å›¾</button>
</div>

<!-- ERROR BOOK -->
<div id="screen-errorbook" class="screen">
  <div class="T1" style="font-size:1.8rem">ğŸ“’ é”™é¢˜æœ¬</div>
  <div class="T2" style="font-size:.88rem;opacity:.6" id="err-count">å…± 0 é“é”™é¢˜</div>
  <div class="err-list" id="err-list"></div>
  <div class="divider"></div>
  <button class="btn btn-p" id="err-practice-btn" onclick="startErrorPractice()">ğŸ¯ ç»ƒä¹ æ‰€æœ‰é”™é¢˜</button>
  <button class="btn btn-ghost btn-sm" onclick="if(confirm('æ¸…ç©ºæ‰€æœ‰é”™é¢˜ï¼Ÿ'))clearErrors();renderErrorBook()">ğŸ—‘ æ¸…ç©ºé”™é¢˜</button>
  <button class="btn btn-ghost btn-sm" onclick="showScreen('home')">â† è¿”å›é¦–é¡µ</button>
</div>

<!-- PARENT PANEL -->
<div id="screen-parent" class="screen">
  <div class="T1" style="font-size:1.7rem">ğŸ‘¨â€ğŸ‘©â€ğŸ‘§ å®¶é•¿é¢æ¿</div>
  <div class="tab-row">
    <button class="tab on" id="tab-overview" onclick="switchTab('overview')">æ€»è§ˆ</button>
    <button class="tab" id="tab-levels" onclick="switchTab('levels')">å„å…³å¡</button>
    <button class="tab" id="tab-history" onclick="switchTab('history')">å†å²è®°å½•</button>
  </div>

  <div class="p-section on" id="ps-overview">
    <div class="p-stat-grid" id="p-stat-grid"></div>
    <div class="card">
      <div style="font-size:.9rem;color:var(--gold);margin-bottom:10px;font-weight:900">ğŸ“Š å„å…³å¡æ­£ç¡®ç‡</div>
      <div id="p-acc-bars"></div>
    </div>
    <div class="card" id="p-error-summary"></div>
  </div>

  <div class="p-section" id="ps-levels">
    <div id="p-levels-detail"></div>
  </div>

  <div class="p-section" id="ps-history">
    <div id="p-history-list" style="max-height:55vh;overflow-y:auto;width:100%"></div>
  </div>

  <button class="btn btn-ghost btn-sm" onclick="showScreen('home')">â† è¿”å›é¦–é¡µ</button>
</div>

</div><!-- /app -->


<!-- Feedback -->
<div id="fb">
  <div id="fb-bg" onclick="dismissFb()"></div>
  <div id="fb-card">
    <div id="fb-em">âœ…</div>
    <div id="fb-msg">å¤ªæ£’äº†ï¼</div>
    <div id="fb-sub">ç»§ç»­åŠ æ²¹ï¼</div>
  </div>
</div>

<!-- Hint Modal -->
<div id="hint-modal">
  <div id="hint-bg" onclick="closeHint()"></div>
  <div id="hint-box">
    <div id="hint-badge" class="hm-badge hm-cou">ğŸ”µ å‡‘åæ³•</div>
    <div id="hint-question" style="margin:10px 0 6px;font-size:1.45rem;font-weight:900;color:#fff;letter-spacing:3px;text-align:center;text-shadow:0 0 14px rgba(255,255,255,.18)">8 + 5 = ï¼Ÿ</div>
    <div id="hint-anim" style="margin:10px 0 14px"></div>
    <div class="hint-steps" id="hint-steps"></div>
    <button class="btn btn-s" style="margin-top:14px;font-size:.95rem" onclick="closeHint()">æ˜ç™½äº†ï¼Œå»ç­”é¢˜ï¼</button>
  </div>
</div>

<!-- Celebration -->
<div id="cel">
  <div class="cel-t" id="cel-t"></div>
  <div style="font-size:3rem" id="cel-s"></div>
  <div class="T2" id="cel-sub"></div>
  <button class="btn btn-p" style="max-width:260px;margin-top:10px" onclick="endCel()">å¤ªå‰å®³äº†ï¼ç»§ç»­ ğŸš€</button>
</div>

<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  LEVELS CONFIG
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const LVS = [
  {id:0, name:'ç«æ˜Ÿ', em:'ğŸ”´', desc:'10ä»¥å†…åŠ æ³•', color:'#ff4757', pass:7, method:null,
   gen(){const a=r(1,9),b=r(1,10-a);return{q:`${a} + ${b} = ?`,a:a+b,op:'+',n1:a,n2:b}}},
  {id:1, name:'æœ¨æ˜Ÿ', em:'ğŸŸ ', desc:'10ä»¥å†…å‡æ³•', color:'#ff7b00', pass:7, method:null,
   gen(){const a=r(2,10),b=r(1,a);return{q:`${a} - ${b} = ?`,a:a-b,op:'-',n1:a,n2:b}}},
  {id:2, name:'åœŸæ˜Ÿ', em:'ğŸª', desc:'è¿›ä½åŠ æ³• (å‡‘åæ³•)', color:'#ffd700', pass:7, method:'cou',
   gen(){
     // Both addends 2-9, sum must be 11-18 (no infinite loop possible)
     const a = r(2,9);
     const minB = Math.max(2, 11-a);  // ensures sum > 10
     const maxB = Math.min(9, 18-a);  // ensures sum <= 18
     const b = r(minB, maxB);
     return {q:`${a} + ${b} = ?`, a:a+b, op:'+', n1:a, n2:b};
   }},
  {id:3, name:'å¤©ç‹æ˜Ÿ', em:'ğŸ”µ', desc:'é€€ä½å‡æ³• (ç ´åæ³•)', color:'#1e90ff', pass:7, method:'po',
   gen(){
     // ones digit 0-7, subtrahend always > ones â†’ borrow guaranteed, no loop
     const ones = r(0, 7);
     const a    = 10 + ones;            // minuend 10-17
     const b    = r(ones + 1, 9);       // subtrahend always > ones digit
     return {q:`${a} - ${b} = ?`, a:a-b, op:'-', n1:a, n2:b};
   }},
  {id:4, name:'å®‡å®™æ ¸å¿ƒ', em:'âœ¨', desc:'ç»ˆææ··åˆé—¯å…³', color:'#c77dff', pass:8, method:'both',
   gen(){const t=r(0,1);
     if(t===0){let a,b;do{a=r(2,9);b=r(2,9)}while(a+b<=10||a+b>20);return{q:`${a} + ${b} = ?`,a:a+b,op:'+',n1:a,n2:b}}
     else{let a,b;do{a=r(11,19);b=r(2,9)}while(a%10>=b);return{q:`${a} - ${b} = ?`,a:a-b,op:'-',n1:a,n2:b}}}}
];

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  TUTORIAL DATA
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const TUT = {
  cou: {
    badge:'ğŸ”µ å‡‘åæ³•', cls:'cou',
    a:8, b:5,  // 8+5=13,  need=2, rest=3
    steps:[
      { title:'ç¬¬ä¸€æ­¥ï¼Œå…ˆå‡‘åï¼',   speak:'æˆ‘ä»¬å…ˆæŠŠæ ¼å­å‡‘æ»¡10ï¼æŠŠé‡‘çƒæ‹–è¿›ç©ºæ ¼å­é‡Œï½', visual:'drag', interactive:true  },
      { title:'å‡‘æˆ10å•¦ï¼ğŸ‰',      speak:'å¤ªæ£’äº†ï¼æ ¼å­è£…æ»¡äº†ï¼Œ10ä¸ªï¼',          visual:'reveal', interactive:false },
      { title:'æœ€åä¸€æ­¥ï¼',         speak:'10å†åŠ ä¸Šå‰©ä¸‹çš„ï¼Œç­”æ¡ˆæ˜¯å¤šå°‘ï¼ŸæŠŠç­”æ¡ˆè¾“è¿›å»ï¼',                     visual:'input',  interactive:true  },
    ]
  },
  po: {
    badge:'ğŸŸ  ç ´åæ³•', cls:'po',
    a:13, b:7,  // 13-7=6
    steps:[
      { title:'è·Ÿç€æˆ‘ç®—ï½',            speak:'13å‡7ç­‰äºå¤šå°‘ï¼Ÿçœ‹æˆ‘æ¥ç®—ï¼',                 visual:'intro'  },
      { title:'ç¬¬ä¸€æ­¥ï¼Œå…ˆç ´åï¼',      speak:'ç¬¬ä¸€æ­¥ï¼Œå…ˆç ´åï¼æŠŠ13åˆ†æˆ10å’Œ3ä¸¤å †ã€‚',       visual:'step1'  },
      { title:'3 + 3 = 6',            speak:'ä»10é‡Œé¢æ‹¿èµ°7ä¸ªï¼Œå‰©ä¸‹3ä¸ªã€‚å†æŠŠå‰©ä¸‹çš„ä¸¤å †ç›¸åŠ ï¼Œå°±å¾—åˆ°æ­£ç¡®ç­”æ¡ˆ6ï¼', visual:'step2'  },
    ]
  }
};

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  STATE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let P = loadData();
let G = {}; // game state
let tutType = 'cou', tutStep = 0;
let curLvId = 0, qs = [], curQ = 0;
let curAns = '', timerV = 15, timerInt = null;
let sCorrect = 0, sStars = 0, sStreak = 0, maxStreak = 0;
let curStreak = 0, gStartTime = 0;
let submitting = false;   // â† é˜²æ­¢é‡å¤æäº¤
let wrongTryCount = 0; // per-question wrong attempts
let voiceOn = true;
let voiceNamePref = (P.voiceNamePref||"" );
// Force preferred voice (user confirmed): å©·å©· (zh-CN)
voiceNamePref = 'å©·å©· (zh-CN)';
P.voiceNamePref = voiceNamePref;
save();
let isErrPractice = false;
let curMethodForHint = null; // 'cou' or 'po' or null
let curQObj = null; // current question object
let couDropped = 0;    // balls dropped into ten-frame (drag step)
let couInputAns = '';  // answer typed on input step

function loadData(){
  const d = localStorage.getItem('mathAdv2');
  if(d){
    const p = JSON.parse(d);
    if(!p.tutsDone) p.tutsDone = [];
    if(!p.voiceNamePref) p.voiceNamePref = "";
    // migrate: if level 2 already unlocked, treat cou as done
    if(p.unlocked.includes(2) && !p.tutsDone.includes('cou')) p.tutsDone.push('cou');
    if(p.unlocked.includes(3) && !p.tutsDone.includes('po'))  p.tutsDone.push('po');
    return p;
  }
  return {unlocked:[0], stars:{}, errors:[], sessions:[], tutsDone:[], voiceNamePref:""};
}
function save(){
  try{localStorage.setItem('mathAdv2', JSON.stringify(P));}catch(e){}
}
function resetAll(){
  P = {unlocked:[0], stars:{}, errors:[], sessions:[], tutsDone:[]};
  save();
  location.reload();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  VOICE  (cartoon-style: high pitch, bright tone)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let _voices = [], _voiceReady = false;
function loadVoices(){
  _voices = speechSynthesis.getVoices();
  _voiceReady = true;
}
if(window.speechSynthesis){
  loadVoices();
  speechSynthesis.onvoiceschanged = loadVoices;
}
function pickVoice(){
  // If user selected a specific voice on this device, use it.
  if(voiceNamePref){
    const exact = _voices.find(v=>v.name===voiceNamePref);
    if(exact) return exact;
  }

  // Otherwise, try pleasant zh-CN voices first
  const pref = ['Xiaoxiao','XiaoXiao','Xiaoyi','Xiaochen','Xiaohan','Xiaomeng','Tingting','Meijia','Sinji',
                 'neural','natural','female','woman','girl','child','kids','Google æ™®é€šè¯','zh-CN'];
  for(const kw of pref){
    const v = _voices.find(v=>v.lang.startsWith('zh') && v.name.toLowerCase().includes(kw.toLowerCase()));
    if(v) return v;
  }
  return _voices.find(v=>v.lang.startsWith('zh')) || null;
}
function speak(text){
  if(!voiceOn) return;
  if(!window.speechSynthesis) return;
  const u = new SpeechSynthesisUtterance(text);
  u.lang  = 'zh-CN';
  u.rate  = 1.12;     // lively
  u.pitch = 1.55 + (Math.random()*0.06-0.03); // clearly cartoon, tiny variation
  const v = pickVoice();
  if(v) u.voice = v;
  speechSynthesis.cancel();
  speechSynthesis.speak(u);
}
function qToSpeech(q){
  // Convert math string into child-friendly Mandarin.
  // Key requirement: 15 -> åäº” (not ä¸€äº”).
  const digit = {'0':'é›¶','1':'ä¸€','2':'äºŒ','3':'ä¸‰','4':'å››','5':'äº”','6':'å…­','7':'ä¸ƒ','8':'å…«','9':'ä¹'};
  const numToZh = (n)=>{
    n = parseInt(n,10);
    if(Number.isNaN(n)) return '';
    if(n<10) return digit[String(n)];
    if(n==10) return 'å';
    if(n<20) return 'å' + digit[String(n%10)];
    if(n<100){
      const t=Math.floor(n/10), u=n%10;
      return digit[String(t)] + 'å' + (u?digit[String(u)] : '');
    }
    // fallback: spell digits
    return String(n).split('').map(ch=>digit[ch]||ch).join('');
  };

  const spoken = q.replace(/\d+/g, m=>numToZh(m))
    .replace(/\+/g,'åŠ ')
    .replace(/\-/g,'å‡')
    .replace(/=\s*\?/g,'ç­‰äºå¤šå°‘ï¼Ÿ');

  return spoken;
}


function toggleVoice(){
  if(voiceOn){
    speak('å…³é—­æœ—è¯»');
    voiceOn = false;
  } else {
    voiceOn = true;
    speak('å¼€å¯æœ—è¯»');
  }
  document.getElementById('voice-btn').className = voiceOn ? '' : 'off';
  document.getElementById('voice-btn').textContent = 'ğŸ—£ï¸';
}




// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  BACKGROUND MUSIC  (Web Audio API)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let bgmCtx = null, bgmGain = null, bgmPlaying = true, bgmNoteIdx = 0, bgmTimer = null;
const BGM_NOTES = [
  // Freq (Hz), duration (s)  â€” cheerful C-major pentatonic melody
  [523.25,0.25],[659.25,0.25],[783.99,0.25],[659.25,0.25],
  [523.25,0.25],[392.00,0.25],[440.00,0.25],[523.25,0.25],
  [659.25,0.25],[783.99,0.25],[1046.5,0.25],[783.99,0.25],
  [659.25,0.25],[523.25,0.25],[659.25,0.5], [523.25,0.5],
  [392.00,0.25],[523.25,0.25],[659.25,0.25],[783.99,0.25],
  [659.25,0.5], [523.25,0.25],[440.00,0.25],[392.00,0.5],
];
function initBgm(){
  if(bgmCtx) return;
  try{
    bgmCtx  = new (window.AudioContext||window.webkitAudioContext)();
    bgmGain = bgmCtx.createGain();
    bgmGain.gain.setValueAtTime(0.055, bgmCtx.currentTime);
    bgmGain.connect(bgmCtx.destination);
    bgmPlaying = true;
    const btn = document.getElementById('bgm-btn');
    if(btn) btn.textContent='ğŸµ';
    playNextNote();
  }catch(e){ console.warn('BGM init failed',e); }
}
function playNextNote(){
  if(!bgmCtx || !bgmPlaying) return;
  if(bgmTimer) clearTimeout(bgmTimer);
  const [freq, dur] = BGM_NOTES[bgmNoteIdx % BGM_NOTES.length];
  bgmNoteIdx++;

  // Main tone: pure sine â€” no vibrato, clean and bright
  const osc = bgmCtx.createOscillator();
  osc.type = 'sine';
  osc.frequency.value = freq;

  // Faint octave overtone for shimmer (glockenspiel feel)
  const osc2 = bgmCtx.createOscillator();
  osc2.type = 'sine';
  osc2.frequency.value = freq * 2;
  const g2 = bgmCtx.createGain();
  g2.gain.value = 0.18;

  // Hard attack â†’ fast exponential decay (toy xylophone / glockenspiel)
  const env = bgmCtx.createGain();
  const t = bgmCtx.currentTime;
  env.gain.setValueAtTime(0.001, t);
  env.gain.linearRampToValueAtTime(1, t + 0.008);
  env.gain.exponentialRampToValueAtTime(0.001, t + dur * 0.85);

  osc.connect(env);
  osc2.connect(g2); g2.connect(env);
  env.connect(bgmGain);

  osc.start(t);  osc.stop(t + dur);
  osc2.start(t); osc2.stop(t + dur);

  bgmTimer = setTimeout(playNextNote, dur * 1000);
}
function toggleBgm(){
  if(!bgmCtx){ initBgm(); return; }
  bgmPlaying = !bgmPlaying;
  if(bgmTimer){ clearTimeout(bgmTimer); bgmTimer=null; }
  if(bgmPlaying){
    bgmGain.gain.setValueAtTime(0.055, bgmCtx.currentTime);
    playNextNote();
  } else {
    clearTimeout(bgmTimer);
    bgmGain.gain.linearRampToValueAtTime(0, bgmCtx.currentTime + 0.3);
  }
  document.getElementById('bgm-btn').textContent = bgmPlaying ? 'ğŸµ' : 'ğŸ”•';
}

function ensureBgmAlive(){
  if(!bgmCtx || !bgmPlaying) return;
  try{
    if(bgmCtx.state==='suspended') bgmCtx.resume().catch(()=>{});
    if(!bgmTimer) playNextNote();
    const btn=document.getElementById('bgm-btn');
    if(btn) btn.textContent='ğŸµ';
  }catch(e){}
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  SCREEN
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function showScreen(id){
  document.querySelectorAll('.screen').forEach(s=>s.classList.remove('active'));
  document.getElementById('screen-'+id).classList.add('active');
  document.getElementById('hint-btn').className = ''; // hide hint btn
  if(id==='map') renderMap();
  if(id==='errorbook') renderErrorBook();
  if(id==='parent') renderParent();
}

// MAP_PATH defines the full journey sequence
const MAP_PATH = [
  {type:'level', id:0},
  {type:'level', id:1},
  {type:'tut',   id:'cou', name:'å‡‘åæ˜Ÿ', desc:'å‡‘åæ³•è®­ç»ƒæ˜Ÿçƒ', em:'ğŸ”µ', color:'cou'},
  {type:'level', id:2},
  {type:'tut',   id:'po',  name:'ç ´åæ˜Ÿ', desc:'ç ´åæ³•è®­ç»ƒæ˜Ÿçƒ', em:'ğŸŸ ', color:'po'},
  {type:'level', id:3},
  {type:'level', id:4},
];

function isNodeAccessible(node){
  if(node.type==='level') return P.unlocked.includes(node.id);
  if(node.type==='tut'){
    if(node.id==='cou') return P.stars[1]!=null || P.unlocked.includes(2) || P.tutsDone.includes('cou');
    if(node.id==='po')  return P.stars[2]!=null || P.unlocked.includes(3) || P.tutsDone.includes('po');
  }
  return false;
}
function isNodeDone(node){
  if(node.type==='level') return P.stars[node.id]!=null;
  if(node.type==='tut')   return P.tutsDone.includes(node.id);
  return false;
}

const ICON_COU_SVG = 'data:image/svg+xml;base64,PHN2ZyB4bWxucz0naHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmcnIHZpZXdCb3g9JzAgMCAyMDAgMjAwJz4KPGRlZnM+CiAgPHJhZGlhbEdyYWRpZW50IGlkPSdzJyBjeD0nNDUlJyBjeT0nNDAlJz4KICAgIDxzdG9wIG9mZnNldD0nMCUnIHN0b3AtY29sb3I9JyNmZmY2YmYnLz4KICAgIDxzdG9wIG9mZnNldD0nMzUlJyBzdG9wLWNvbG9yPScjZmZkNzZhJy8+CiAgICA8c3RvcCBvZmZzZXQ9JzcwJScgc3RvcC1jb2xvcj0nI2ZmOWEyZicvPgogICAgPHN0b3Agb2Zmc2V0PScxMDAlJyBzdG9wLWNvbG9yPScjZTI0YjEyJy8+CiAgPC9yYWRpYWxHcmFkaWVudD4KICA8ZmlsdGVyIGlkPSdub2lzZSc+CiAgICA8ZmVUdXJidWxlbmNlIHR5cGU9J2ZyYWN0YWxOb2lzZScgYmFzZUZyZXF1ZW5jeT0nLjknIG51bU9jdGF2ZXM9JzInIHN0aXRjaFRpbGVzPSdzdGl0Y2gnLz4KICAgIDxmZUNvbG9yTWF0cml4IHR5cGU9J21hdHJpeCcgdmFsdWVzPScxIDAgMCAwIDAgIDAgLjcgMCAwIDAgIDAgMCAuMiAwIDAgIDAgMCAwIC4yNSAwJy8+CiAgPC9maWx0ZXI+CjwvZGVmcz4KPGNpcmNsZSBjeD0nMTAwJyBjeT0nMTAwJyByPSc4NicgZmlsbD0ndXJsKCNzKScvPgo8Y2lyY2xlIGN4PScxMDAnIGN5PScxMDAnIHI9Jzg2JyBmaWx0ZXI9J3VybCgjbm9pc2UpJyBvcGFjaXR5PScuNzUnLz4KPGcgb3BhY2l0eT0nLjM1Jz4KICA8Y2lyY2xlIGN4PSc3OCcgY3k9Jzc4JyByPScxNicgZmlsbD0ncmdiYSgyNTUsMjU1LDI1NSwuMjUpJy8+CiAgPGNpcmNsZSBjeD0nMTI4JyBjeT0nMTE4JyByPScxMicgZmlsbD0ncmdiYSgwLDAsMCwuMTApJy8+CiAgPGNpcmNsZSBjeD0nMTIwJyBjeT0nNzgnIHI9JzgnIGZpbGw9J3JnYmEoMjU1LDI1NSwyNTUsLjE4KScvPgo8L2c+Cjwvc3ZnPg==';
const ICON_PO_SVG  = 'data:image/svg+xml;base64,PHN2ZyB4bWxucz0naHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmcnIHZpZXdCb3g9JzAgMCAyMDAgMjAwJz4KPGRlZnM+CiAgPHJhZGlhbEdyYWRpZW50IGlkPSdvJyBjeD0nNDAlJyBjeT0nMzUlJz4KICAgIDxzdG9wIG9mZnNldD0nMCUnIHN0b3AtY29sb3I9JyNjOGYxZmYnLz4KICAgIDxzdG9wIG9mZnNldD0nNTUlJyBzdG9wLWNvbG9yPScjM2FhOWZmJy8+CiAgICA8c3RvcCBvZmZzZXQ9JzEwMCUnIHN0b3AtY29sb3I9JyMwZDJmNmInLz4KICA8L3JhZGlhbEdyYWRpZW50PgogIDxyYWRpYWxHcmFkaWVudCBpZD0nZycgY3g9JzQ1JScgY3k9JzQwJSc+CiAgICA8c3RvcCBvZmZzZXQ9JzAlJyBzdG9wLWNvbG9yPScjY2ZmZjljJy8+CiAgICA8c3RvcCBvZmZzZXQ9JzEwMCUnIHN0b3AtY29sb3I9JyMyZmJmNjInLz4KICA8L3JhZGlhbEdyYWRpZW50Pgo8L2RlZnM+CjxjaXJjbGUgY3g9JzEwMCcgY3k9JzEwMCcgcj0nODYnIGZpbGw9J3VybCgjbyknLz4KPCEtLSBzaW1wbGUgY29udGluZW50cyAtLT4KPHBhdGggZD0nTTY1IDg1YzEwLTE4IDMwLTIyIDQ4LTEwIDggNSAxMiAxNCAxMCAyMi0zIDEyLTEyIDE2LTI2IDE1LTE0LTEtMzAgMi0zMi0yN3onIGZpbGw9J3VybCgjZyknIG9wYWNpdHk9Jy45NScvPgo8cGF0aCBkPSdNMTIwIDEyMGMxNC02IDI2IDIgMjggMTQgMiAxMi02IDIyLTE4IDIyLTEwIDAtMTgtMTAtMTgtMTggMC03IDQtMTMgOC0xOHonIGZpbGw9J3VybCgjZyknIG9wYWNpdHk9Jy45Jy8+CjxwYXRoIGQ9J003OCAxMzJjNi00IDE0LTMgMTggMyA0IDYgMiAxNC00IDE4LTYgNC0xNCAyLTE4LTQtNC02LTEtMTIgNC0xN3onIGZpbGw9J3VybCgjZyknIG9wYWNpdHk9Jy44NScvPgo8IS0tIGNsb3VkcyBoaWdobGlnaHQgLS0+CjxnIG9wYWNpdHk9Jy4yNScgZmlsbD0nI2ZmZic+CiAgPHBhdGggZD0nTTU4IDExMGMxOC0xMCA0MC0xMCA1OCAwJyBzdHJva2U9JyNmZmYnIHN0cm9rZS13aWR0aD0nMTAnIHN0cm9rZS1saW5lY2FwPSdyb3VuZCcgZmlsbD0nbm9uZScvPgogIDxwYXRoIGQ9J001NSA5NWMyMC0xMiA1MC0xMiA3MCAwJyBzdHJva2U9JyNmZmYnIHN0cm9rZS13aWR0aD0nOCcgc3Ryb2tlLWxpbmVjYXA9J3JvdW5kJyBmaWxsPSdub25lJy8+CjwvZz4KPCEtLSBzcGVjdWxhciAtLT4KPGNpcmNsZSBjeD0nNzgnIGN5PSc3OCcgcj0nMTgnIGZpbGw9J3JnYmEoMjU1LDI1NSwyNTUsLjE4KScvPgo8L3N2Zz4=';

function renderMap(){
  try{
  const total = Object.values(P.stars).reduce((a,b)=>a+b,0);
  document.getElementById('map-total').textContent = total;

  const wrap = document.getElementById('space-map-wrap');
  wrap.innerHTML = '';

  // â”€â”€ Layout positions (% of wrap's 100% wide Ã— 500px tall)
  // zigzag across the space, bottom-start â†’ top-finish
  const POSITIONS = [
    {x:22, y:87},   // 0: ç«æ˜Ÿ
    {x:68, y:74},   // 1: æœ¨æ˜Ÿ
    {x:82, y:56},   // 2: å‡‘åæ³• (tut)
    {x:35, y:42},   // 3: åœŸæ˜Ÿ
    {x:18, y:26},   // 4: ç ´åæ³• (tut)
    {x:64, y:14},   // 5: å¤©ç‹æ˜Ÿ
    {x:40, y:3 },   // 6: å®‡å®™æ ¸å¿ƒ
  ];

  // Planet visual configs
  const LV_CFG = [
    {size:74, bg:'radial-gradient(circle at 30% 28%,rgba(255,255,255,.22),transparent 40%),radial-gradient(circle at 65% 65%,rgba(0,0,0,.25),transparent 52%),radial-gradient(135deg,#ff6b7a,#c0392b)', glowColor:'rgba(255,107,122,.5)', glowBase:'0 6px 20px rgba(255,50,50,.4)'},
    {size:78, bg:'radial-gradient(circle at 28% 30%,rgba(255,255,255,.18),transparent 42%),radial-gradient(circle at 70% 70%,rgba(0,0,0,.22),transparent 55%),radial-gradient(135deg,#ffa040,#e67e22)', glowColor:'rgba(255,160,64,.5)',  glowBase:'0 6px 20px rgba(255,120,0,.4)'},
    {size:82, bg:'radial-gradient(circle at 30% 28%,rgba(255,255,255,.22),transparent 45%),radial-gradient(circle at 72% 72%,rgba(0,0,0,.24),transparent 56%),radial-gradient(135deg,#f7d060,#c9a227)', glowColor:'rgba(247,208,96,.5)',  glowBase:'0 6px 20px rgba(200,160,0,.4)'},
    {size:78, bg:'radial-gradient(circle at 28% 30%,rgba(255,255,255,.20),transparent 45%),radial-gradient(circle at 70% 70%,rgba(0,0,0,.22),transparent 56%),radial-gradient(135deg,#4fa3e3,#1a6fb0)', glowColor:'rgba(79,163,227,.5)',  glowBase:'0 6px 20px rgba(30,100,200,.4)'},
    {size:86, bg:'radial-gradient(circle at 30% 28%,rgba(255,255,255,.20),transparent 45%),radial-gradient(circle at 70% 70%,rgba(0,0,0,.25),transparent 56%),radial-gradient(135deg,#d4a8ff,#8a2be2)', glowColor:'rgba(180,130,255,.5)', glowBase:'0 6px 24px rgba(140,50,220,.5)'},
  ];
  const FLOAT_DUR = ['3.8s','4.4s','3.2s','4.9s','3.6s','4.2s','5s'];

  // â”€â”€ Background mini stars
  for(let i=0;i<55;i++){
    const s = document.createElement('div');
    s.className = 'map-star';
    const sz = Math.random()*2+.5;
    s.style.cssText = `width:${sz}px;height:${sz}px;left:${Math.random()*100}%;top:${Math.random()*100}%;--d:${1.5+Math.random()*3}s;animation-delay:${Math.random()*3}s;opacity:${.3+Math.random()*.7}`;
    wrap.appendChild(s);
  }

  // â”€â”€ SVG flight-path layer
  const svg = document.createElementNS('http://www.w3.org/2000/svg','svg');
  svg.setAttribute('class','map-svg');
  svg.setAttribute('viewBox','0 0 100 100');
  svg.setAttribute('preserveAspectRatio','none');

  const W = wrap.offsetWidth || 440;
  const H = 500;

  // Build paths first, collect done-path data for rockets
  const rocketPaths = [];
  MAP_PATH.forEach((node, idx)=>{
    if(idx===0) return;
    const prev = POSITIONS[idx-1];
    const cur  = POSITIONS[idx];
    const prevDone = isNodeDone(MAP_PATH[idx-1]);
    const x1 = prev.x, y1 = prev.y, x2 = cur.x, y2 = cur.y;
    const mx = (x1+x2)/2 + (idx%2===0?6:-6);
    const my = (y1+y2)/2;
    const pathId = `mp-${idx}`;

    const path = document.createElementNS('http://www.w3.org/2000/svg','path');
    path.setAttribute('id', pathId);
    path.setAttribute('d',`M${x1},${y1} Q${mx},${my} ${x2},${y2}`);
    path.setAttribute('fill','none');
    path.setAttribute('stroke', prevDone ? 'rgba(255,215,0,.5)' : 'rgba(255,255,255,.15)');
    path.setAttribute('stroke-width', prevDone ? '.8' : '.6');
    path.setAttribute('stroke-dasharray', node.type==='tut' ? '1.5,1.5' : '2,2');
    path.setAttribute('stroke-linecap','round');
    svg.appendChild(path);

    if(prevDone) rocketPaths.push({pathId, dur: 3+idx*.4});
  });

  // Append SVG to DOM first, THEN add mpath rockets (mpath needs live DOM)
  wrap.appendChild(svg);

  rocketPaths.forEach(({pathId, dur})=>{
    try{
      const rocket = document.createElementNS('http://www.w3.org/2000/svg','text');
      rocket.textContent = 'ğŸš€';
      rocket.setAttribute('font-size','3.5');
      rocket.setAttribute('text-anchor','middle');
      rocket.setAttribute('dominant-baseline','middle');
      const anim = document.createElementNS('http://www.w3.org/2000/svg','animateMotion');
      anim.setAttribute('dur', dur+'s');
      anim.setAttribute('repeatCount','indefinite');
      anim.setAttribute('rotate','auto');
      const mp = document.createElementNS('http://www.w3.org/2000/svg','mpath');
      mp.setAttributeNS('http://www.w3.org/1999/xlink','xlink:href','#'+pathId);
      mp.setAttribute('href','#'+pathId);
      anim.appendChild(mp);
      rocket.appendChild(anim);
      svg.appendChild(rocket);
    }catch(e){ /* animateMotion not supported, skip rocket */ }
  });

  // â”€â”€ Planet / Tutorial nodes
  MAP_PATH.forEach((node, idx)=>{
    const pos        = POSITIONS[idx];
    const accessible = isNodeAccessible(node);
    const done       = isNodeDone(node);
    const fdur       = FLOAT_DUR[idx];

    if(node.type==='level'){
      const lv  = LVS[node.id];
      const cfg = LV_CFG[node.id];
      const st  = P.stars[node.id]||0;

      const el = document.createElement('div');
      el.className = 'planet-node ' + (accessible ? 'accessible' : 'locked');
      el.style.cssText = `left:${pos.x}%;top:${pos.y}%`;

      const glowBase  = done ? '0 0 24px '+cfg.glowColor+','+cfg.glowBase : cfg.glowBase;
      const animClass = accessible && !done ? 'pulse-glow' : 'float-only';

      el.innerHTML = `
        <div class="planet-body ${animClass}"
          style="width:${cfg.size}px;height:${cfg.size}px;
          background:${cfg.bg};
          --fd:${fdur};
          --glow-base:${cfg.glowBase};
          --glow-color:${cfg.glowColor};
          box-shadow:${glowBase};
          border-color:${done?cfg.glowColor:'rgba(255,255,255,.18)'}">
          <span class="planet-em" style="display:none">${lv.em}</span><div class="planet-surface planet-skin-${lv.id}"></div><div class="planet-ring"></div>
          ${!accessible ? '<div class="planet-lock-icon">ğŸ”’</div>' : ''}
          
        </div>
        <div class="planet-name">${lv.name}</div>
        ${done ? `<div class="planet-stars">${'â­'.repeat(st)}${'â˜†'.repeat(3-st)}</div>` : ''}
      `;
      if(accessible) el.onclick = ()=>startLevel(node.id);
      wrap.appendChild(el);

    } else if(node.type==='tut'){
      // Render tutorial nodes as real planets (same style system as levels)
      const isCou = node.id==='cou';
      const cfg = isCou
        ? {size:78, bg:'radial-gradient(circle at 28% 30%,rgba(255,255,255,.20),transparent 45%),radial-gradient(circle at 70% 70%,rgba(0,0,0,.22),transparent 56%),radial-gradient(135deg,#4fa3e3,#1a6fb0)', glowColor:'rgba(30,144,255,.55)', glowBase:'0 6px 22px rgba(30,100,200,.35)'}
        : {size:78, bg:'radial-gradient(circle at 28% 30%,rgba(255,255,255,.18),transparent 42%),radial-gradient(circle at 70% 70%,rgba(0,0,0,.22),transparent 55%),radial-gradient(135deg,#ffa040,#e67e22)', glowColor:'rgba(255,123,0,.55)', glowBase:'0 6px 22px rgba(255,120,0,.35)'};

      const el = document.createElement('div');
      el.className = 'planet-node ' + (accessible ? 'accessible' : 'locked');
      el.style.cssText = `left:${pos.x}%;top:${pos.y}%`;

      const glowBase = cfg.glowBase + ', 0 0 26px ' + cfg.glowColor;
      const animClass = accessible ? 'pulse-glow' : 'float-only';
      const em = isCou ? 'ğŸ”µ' : 'ğŸŸ ';

      el.innerHTML = `
        <div class="planet-body ${animClass}"
          style="width:${cfg.size}px;height:${cfg.size}px;
          background:${cfg.bg};
          --fd:${fdur};
          --glow-base:${cfg.glowBase};
          --glow-color:${cfg.glowColor};
          box-shadow:${glowBase};
          border-color:${cfg.glowColor}">
          <span class="planet-em" style="display:none">${em}</span>
          <div class="planet-surface"></div>
          <div class="planet-ring"></div>
          ${!accessible ? '<div class="planet-lock-icon">ğŸ”’</div>' : ''}
        </div>
        <div class="planet-name">${node.name}</div>
      `;

      // Force-set the icon for å‡‘åæ˜Ÿ/ç ´åæ˜Ÿ
      try{
        const surf = el.querySelector('.planet-surface');
        if(surf){
          surf.style.backgroundImage = `url('${isCou?ICON_COU_SVG:ICON_PO_SVG}')`;
          surf.style.backgroundSize = 'cover';
          surf.style.backgroundPosition = 'center';
        }
      }catch(e){}

      if(accessible) el.onclick = ()=>startTutorial(node.id);
      wrap.appendChild(el);
    }
  });
} catch(e){ console.error('renderMap error:',e); }
}
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  TUTORIAL
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function completeTutorial(type){
  if(!P.tutsDone.includes(type)) P.tutsDone.push(type);
  // unlock corresponding level
  const lvId = type==='cou' ? 2 : 3;
  if(!P.unlocked.includes(lvId)) P.unlocked.push(lvId);
  save();
}

function startTutorial(type){
  tutType = type;
  tutStep = 0;
  couDropped = 0;
  couInputAns = '';
  const t = TUT[type];
  const badge = document.getElementById('tut-badge-el');
  badge.textContent = t.badge;
  badge.className = 'tut-badge '+t.cls;
  // Set the fixed question banner
  const banner = document.getElementById('tut-question-banner');
  if(banner){
    if(type==='cou'){
      banner.textContent = `${t.a} + ${t.b} = ï¼Ÿ`;
      banner.style.display = '';
    } else {
      // ç ´åæ³•ï¼šä¾‹é¢˜ä¸€ç›´æ”¾åœ¨é¡¶éƒ¨
      banner.textContent = `${t.a} - ${t.b} = ï¼Ÿ`;
      banner.style.display = '';
    }
  }
  renderTutStep();
  showScreen('tutorial');
  speak(t.steps[0].speak || t.steps[0].title);
}

function tutNav(dir){
  const t = TUT[tutType];
  tutStep = Math.max(0, Math.min(t.steps.length-1, tutStep+dir));
  renderTutStep();
  speak(t.steps[tutStep].speak || t.steps[tutStep].title);
}

function renderTutStep(){
  const t = TUT[tutType];
  const s = t.steps[tutStep];
  const total = t.steps.length;

  // Step dots
  let dots = '';
  for(let i=0;i<total;i++) dots+=`<div class="sd${i===tutStep?' on':''}"></div>`;
  document.getElementById('tut-dots').innerHTML = dots;

  // Nav buttons â€” hide entirely for interactive steps (drag / input)
  const navRow = document.getElementById('tut-nav-row');
  const prevBtn = document.getElementById('tut-prev');
  const nextBtn = document.getElementById('tut-next');
  if(s.interactive){
    navRow.style.display = 'none';
  } else {
    navRow.style.display = '';
    prevBtn.style.display = tutStep===0 ? 'none' : '';
    if(tutStep===total-1){
      nextBtn.textContent = 'âœ… å»é—¯å…³ï¼';
      nextBtn.onclick = ()=>{ completeTutorial(tutType); startLevel(tutType==='cou'?2:3); };
    } else {
      nextBtn.textContent = 'ä¸‹ä¸€æ­¥ â†’';
      nextBtn.onclick = ()=>tutNav(1);
    }
  }

  // Title
  document.getElementById('tut-title').textContent = s.title;
  const descEl = document.getElementById('tut-desc');
  if(descEl) descEl.style.display = 'none';

  // Visual
  const vis = document.getElementById('tut-visual');
  vis.classList.remove('fade-in');
  void vis.offsetWidth;
  vis.classList.add('fade-in');

  if(tutType==='cou') renderCouVisual(s.visual, t.a, t.b);
  else renderPoVisual(s.visual, t.a, t.b);
}

function renderCouVisual(step, a, b){
  const need = 10 - a;   // 8+5: need=2
  const rest = b - need; // 8+5: rest=3
  const vis  = document.getElementById('tut-visual');
  const BLUE='#1e90ff', GOLD='#ffd700', GREEN='#00d46a';

  // ---------- HELPER RENDERERS ----------
  function tenFrameStatic(filled, filledColor, extra, extraColor){
    let h = `<div style="display:grid;grid-template-columns:repeat(5,1fr);gap:6px;padding:10px;background:rgba(255,255,255,.06);border-radius:16px;border:2px solid rgba(255,255,255,.12)">`;
    for(let i=0;i<10;i++){
      let bg = '';
      if(i<filled)         bg = filledColor;
      else if(i<filled+extra) bg = extraColor;
      h += bg
        ? `<div style="width:38px;height:38px;border-radius:50%;background:${bg};box-shadow:0 2px 8px rgba(0,0,0,.4)"></div>`
        : `<div style="width:38px;height:38px;border-radius:50%;border:2px dashed rgba(255,255,255,.2)"></div>`;
    }
    return h + '</div>';
  }
  function dotRow(count, color){
    let h = `<div style="display:flex;flex-wrap:wrap;gap:7px;justify-content:center">`;
    for(let i=0;i<count;i++)
      h += `<div style="width:38px;height:38px;border-radius:50%;background:${color};box-shadow:0 2px 8px rgba(0,0,0,.35)"></div>`;
    return h+'</div>';
  }
  function lbl(text, color){ return `<div style="font-size:.9rem;color:${color||'rgba(255,255,255,.6)'};text-align:center;margin:3px 0">${text}</div>`; }

  // ---------- STEP: intro ----------
  if(step==='intro'){
    vis.innerHTML = `<div style="display:flex;flex-direction:column;gap:10px">
      ${lbl(a+' ä¸ªè“çƒ', BLUE)}
      <div style="margin:0 0 4px">${dotRow(a, BLUE)}</div>
      <div style="font-size:1.4rem;color:rgba(255,255,255,.4);text-align:center">+</div>
      ${lbl(b+' ä¸ªé‡‘çƒ', GOLD)}
      <div style="margin:0">${dotRow(b, GOLD)}</div>
    </div>`;
    return;
  }

  // ---------- STEP: drag (interactive) ----------
  if(step==='drag'){
    couDropped = 0;
    let frameHtml = `<div id="cou-frame" style="display:grid;grid-template-columns:repeat(5,1fr);gap:6px;padding:10px;background:rgba(255,255,255,.06);border-radius:16px;border:2px solid rgba(255,255,255,.12)">`;
    for(let i=0;i<10;i++){
      if(i<a){
        frameHtml += `<div style="width:38px;height:38px;border-radius:50%;background:${BLUE};box-shadow:0 2px 8px rgba(0,0,0,.4)"></div>`;
      } else {
        frameHtml += `<div class="drop-slot" data-idx="${i-a}"
          style="width:38px;height:38px;border-radius:50%;border:3px dashed rgba(255,215,0,.5);
          transition:all .25s;display:flex;align-items:center;justify-content:center;cursor:pointer"
          ondragover="event.preventDefault();this.style.borderColor='#fff';this.style.background='rgba(255,215,0,.2)'"
          ondragleave="this.style.borderColor='rgba(255,215,0,.5)';this.style.background=''"
          ondrop="couDrop(this)"></div>`;
      }
    }
    frameHtml += '</div>';

    let ballsHtml = `<div id="cou-balls" style="display:flex;flex-wrap:wrap;gap:10px;justify-content:center;padding:6px">`;
    for(let i=0;i<b;i++){
      ballsHtml += `<div class="drag-ball" data-bi="${i}" draggable="true"
        style="width:44px;height:44px;border-radius:50%;background:${GOLD};
        box-shadow:0 3px 12px rgba(255,215,0,.5);cursor:grab;
        display:flex;align-items:center;justify-content:center;font-size:.7rem;
        color:rgba(0,0,0,.5);font-weight:900;user-select:none;
        transition:transform .15s,opacity .3s;touch-action:none"
        ondragstart="couDragStart(this)">â˜…</div>`;
    }
    ballsHtml += '</div>';

    vis.innerHTML = `<div style="display:flex;flex-direction:column;gap:10px">
      <div style="background:rgba(255,215,0,.1);border:2px dashed rgba(255,215,0,.4);border-radius:12px;padding:8px;text-align:center">
        <span style="font-size:1.1rem;color:${GOLD};font-weight:900">æŠŠé‡‘çƒæ‹–è¿›ç©ºæ ¼å­é‡Œï¼è¿˜å·® <span id="cou-need-label">${need}</span> ä¸ª</span>
      </div>
      ${frameHtml}
      <div style="font-size:.85rem;color:rgba(255,255,255,.5);text-align:center">ğŸ‘‡ é‡‘çƒä»¬åœ¨ä¸‹é¢ï¼Œæ‹–ä¸Šå»ï¼</div>
      ${ballsHtml}
    </div>`;

    // Set up touch drag after DOM is injected
    setTimeout(couInitTouch, 50);
    return;
  }

  // ---------- STEP: reveal (auto) ----------
  if(step==='reveal'){
    vis.innerHTML = `<div style="display:flex;flex-direction:column;gap:10px">
      ${lbl('æ ¼å­è£…æ»¡å•¦ï¼å…± 10 ä¸ª ğŸ‰', GREEN)}
      ${tenFrameStatic(10, GREEN, 0, '')}
      <div style="font-size:1.4rem;color:rgba(255,255,255,.4);text-align:center">+</div>
      ${lbl('è¿˜å‰© '+rest+' ä¸ªé‡‘çƒ', GOLD)}
      ${dotRow(rest, GOLD)}
    </div>`;
    return;
  }

  // ---------- STEP: input (interactive â€” child types 10+rest=?) ----------
  if(step==='input'){
    couInputAns = '';
    vis.innerHTML = `<div style="display:flex;flex-direction:column;gap:10px">
      ${tenFrameStatic(10, GREEN, 0, '')}
      <div style="font-size:.8rem;color:rgba(255,255,255,.4);text-align:center">â†‘ è¿™æ˜¯ 10 ä¸ª</div>
      ${dotRow(rest, GOLD)}
      <div style="font-size:.8rem;color:rgba(255,255,255,.4);text-align:center">â†‘ è¿™æ˜¯ ${rest} ä¸ª</div>
      <div style="background:rgba(255,255,255,.06);border-radius:16px;padding:14px;text-align:center">
        <div style="font-size:1.6rem;color:#fff;font-weight:900;letter-spacing:4px;margin-bottom:10px">
          10 + ${rest} = <span id="cou-ans-display" style="color:${GOLD};min-width:48px;display:inline-block;border-bottom:3px solid ${GOLD}">ã€€</span>
        </div>
        <div id="cou-mini-np" style="display:grid;grid-template-columns:repeat(3,1fr);gap:7px;max-width:240px;margin:0 auto">
          ${[7,8,9,4,5,6,1,2,3,'âŒ«',0,'âœ“'].map(k=>`
            <div onclick="couNpKey('${k}')"
              style="padding:12px 4px;border-radius:12px;text-align:center;cursor:pointer;
              font-size:1.3rem;font-weight:900;
              background:${k==='âœ“'?'rgba(0,212,106,.3)':k==='âŒ«'?'rgba(255,71,87,.2)':'rgba(255,255,255,.08)'};
              color:${k==='âœ“'?'#00d46a':k==='âŒ«'?'#ff8c96':'#fff'};
              border:1.5px solid ${k==='âœ“'?'rgba(0,212,106,.4)':'rgba(255,255,255,.1)'};
              transition:all .1s;user-select:none"
              ontouchstart="this.style.transform='scale(.9)'" ontouchend="this.style.transform=''">
              ${k}
            </div>
          `).join('')}
        </div>
        <div id="cou-input-msg" style="min-height:24px;margin-top:8px;font-size:.9rem"></div>
      </div>
    </div>`;
    return;
  }
}

// â”€â”€â”€ Drag helpers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let _dragBall = null;

function couDragStart(el){
  _dragBall = el;
  el.style.opacity = '0.4';
}

function couDrop(slot){
  if(!_dragBall || slot.childElementCount > 0) return;
  const ball = _dragBall;
  _dragBall = null;

  const dot = document.createElement('div');
  dot.style.cssText = 'width:38px;height:38px;border-radius:50%;background:#00d46a;box-shadow:0 0 14px rgba(0,212,106,.6)';
  slot.style.borderColor = '#00d46a';
  slot.style.background  = 'rgba(0,212,106,.15)';
  slot.innerHTML='';
  slot.appendChild(dot);

  try{ ball.style.opacity='0'; ball.style.pointerEvents='none'; }catch(e){}

  couDropped++;
  const t = TUT.cou;
  const need = 10 - t.a;
  const lbl = document.getElementById('cou-need-label');
  if(lbl) lbl.textContent = Math.max(0, need - couDropped);

  if(couDropped >= need){
    setTimeout(()=>{
      speak('å¤ªæ£’äº†ï¼æ ¼å­è£…æ»¡äº†ï¼Œ10ä¸ªï¼è¿˜å‰©ä¸‹3ä¸ªé‡‘çƒã€‚');
      tutStep++;
      renderTutStep();
    }, 500);
  }
}

// Touch drag for mobile
let _touchBall = null, _touchClone = null;

function couInitTouch(){
  document.querySelectorAll('.drag-ball').forEach(ball=>{
    ball.addEventListener('touchstart', e=>{
      e.preventDefault();
      _touchBall = ball;
      const t = e.touches[0];
      _touchClone = ball.cloneNode(true);
      _touchClone.style.cssText += `;position:fixed;z-index:999;pointer-events:none;
        width:44px;height:44px;opacity:.85;transform:scale(1.2);
        left:${t.clientX-22}px;top:${t.clientY-22}px;transition:none`;
      document.body.appendChild(_touchClone);
      ball.style.opacity = '.3';
    }, {passive:false});

    ball.addEventListener('touchmove', e=>{
      e.preventDefault();
      if(!_touchClone) return;
      const t = e.touches[0];
      _touchClone.style.left = (t.clientX-22)+'px';
      _touchClone.style.top  = (t.clientY-22)+'px';
      // Highlight slot under finger
      document.querySelectorAll('.drop-slot').forEach(s=>{
        const r = s.getBoundingClientRect();
        const over = t.clientX>=r.left && t.clientX<=r.right && t.clientY>=r.top && t.clientY<=r.bottom;
        s.style.borderColor = over ? '#fff' : 'rgba(255,215,0,.5)';
        s.style.background  = over ? 'rgba(255,215,0,.2)' : '';
      });
    }, {passive:false});

    ball.addEventListener('touchend', e=>{
      if(!_touchClone) return;
      const t = e.changedTouches[0];
      if(_touchClone) _touchClone.remove();
      _touchClone = null;
      // Find slot under finger
      let found = null;
      document.querySelectorAll('.drop-slot').forEach(s=>{
        const r = s.getBoundingClientRect();
        if(t.clientX>=r.left && t.clientX<=r.right && t.clientY>=r.top && t.clientY<=r.bottom)
          found = s;
      });
      if(found && found.childElementCount===0){
        couDrop(found);
      } else if(_touchBall){
        _touchBall.style.opacity = '1';
      }
      _touchBall = null;
    });
  });
}

// Mini numpad for input step
function couNpKey(k){
  if(k==='âŒ«'){
    couInputAns = couInputAns.slice(0,-1);
  } else if(k==='âœ“'){
    couNpSubmit();
    return;
  } else {
    if(couInputAns.length >= 2) return;
    couInputAns += k;
  }
  const d = document.getElementById('cou-ans-display');
  if(d) d.textContent = couInputAns || 'ã€€';
}

function couNpSubmit(){
  const t   = TUT.cou;
  const ans = parseInt(couInputAns);
  const msg = document.getElementById('cou-input-msg');
  if(ans === t.a + t.b){
    if(msg){ msg.textContent = 'ğŸ‰ ç­”å¯¹å•¦ï¼'; msg.style.color = '#00d46a'; }
    playChime();
    speak('ç­”å¯¹äº†ï¼'+t.a+'åŠ '+t.b+'ç­‰äº'+(t.a+t.b)+'ï¼å¤ªæ£’äº†ï¼');
    spawnParticles();
    setTimeout(()=>{ completeTutorial('cou'); startLevel(2); }, 1600);
  } else {
    if(msg){ msg.textContent = 'å†æƒ³æƒ³ï½é‡æ–°è¾“ï¼'; msg.style.color = '#ff8c96'; }
    couInputAns = '';
    const d = document.getElementById('cou-ans-display');
    if(d){ d.textContent='ã€€'; d.style.animation='none'; void d.offsetWidth; d.style.animation=''; }
    speak('å“å‘€ï¼Œå†è¯•ä¸€æ¬¡ï¼');
  }
}

function playChime(){
  if(!bgmCtx) return;
  const freqs = [783.99, 1046.5, 1318.5, 1567.98];
  freqs.forEach((f,i)=>{
    setTimeout(()=>{
      const o=bgmCtx.createOscillator(), e=bgmCtx.createGain();
      o.type='sine'; o.frequency.value=f;
      e.gain.setValueAtTime(0,bgmCtx.currentTime);
      e.gain.linearRampToValueAtTime(0.3,bgmCtx.currentTime+0.01);
      e.gain.exponentialRampToValueAtTime(0.001,bgmCtx.currentTime+0.5);
      o.connect(e); e.connect(bgmCtx.destination);
      o.start(); o.stop(bgmCtx.currentTime+0.5);
    }, i*120);
  });
}


function renderPoVisual(step, a, b){
  const units    = a % 10;      // 13-7: units=3
  const fromTen  = 10 - b;      // 13-7: fromTen=3
  const vis = document.getElementById('tut-visual');

  const BLUE='#1e90ff', GOLD='#ffd700', GREEN='#00d46a', RED='#ff4757', ORANGE='#ff7b00', DIM='rgba(255,255,255,.2)';

  function bigEq(text, color){
    return `<div style="font-size:2rem;font-weight:900;color:${color||'#fff'};text-align:center;text-shadow:0 0 15px rgba(255,255,255,.2)">${text}</div>`;
  }
  function label(text, color){
    return `<div style="font-size:.88rem;color:${color||'rgba(255,255,255,.55)'};text-align:center;margin:2px 0">${text}</div>`;
  }
  function dotGroup(count, color){
    let html = `<div style="display:flex;flex-wrap:wrap;gap:6px;justify-content:center">`;
    for(let i=0;i<count;i++)
      html += `<div style="width:38px;height:38px;border-radius:50%;background:${color};box-shadow:0 2px 8px rgba(0,0,0,.35)"></div>`;
    html += `</div>`;
    return html;
  }
  function dotGroupStrike(count, strikeCount, color, strikeColor){
    let html = `<div style="display:flex;flex-wrap:wrap;gap:6px;justify-content:center">`;
    for(let i=0;i<count;i++){
      if(i < strikeCount)
        html += `<div style="width:38px;height:38px;border-radius:50%;background:${strikeColor};opacity:.35;position:relative"></div>`;
      else
        html += `<div style="width:38px;height:38px;border-radius:50%;background:${color};box-shadow:0 2px 8px rgba(0,0,0,.35)"></div>`;
    }
    html += `</div>`;
    return html;
  }
  function pile(labelText, count, color, extraStyle){
    return `<div style="background:rgba(255,255,255,.05);border-radius:14px;padding:10px;text-align:center;flex:1;${extraStyle||''}">
      <div style="font-size:1.1rem;font-weight:900;color:${color};margin-bottom:7px">${labelText}</div>
      ${dotGroup(count, color)}
    </div>`;
  }

  let html = '';
  switch(step){
    case 'intro':
      html += bigEq(`${a} - ${b} = ï¼Ÿ`, '#fff');
      html += `<div style="margin:8px 0">`;
      html += label(`${a} ä¸ªè“çƒ`, BLUE);
      html += dotGroup(a, BLUE);
      html += `</div>`;
      html += `<div style="background:rgba(255,71,87,.12);border:2px dashed rgba(255,71,87,.4);border-radius:14px;padding:10px;text-align:center">
        <span style="font-size:1.2rem;color:${RED};font-weight:900">è¦æ‹¿èµ° ${b} ä¸ª</span>
      </div>`;
      break;

    case 'step1':
      html += label(`æŠŠ ${a} ä¸ªåˆ†æˆä¸¤å †`, 'rgba(255,255,255,.7)');
      html += `<div style="display:flex;gap:10px;margin:8px 0">`;
      html += pile('10 ä¸ª', 10, BLUE);
      html += pile(`${units} ä¸ª`, units, GOLD);
      html += `</div>`;
      break;

    case 'step2':
      html += label(`ä» 10 é‡Œæ‹¿èµ° ${b} ä¸ª`, 'rgba(255,255,255,.7)');
      html += `<div style="background:rgba(255,255,255,.05);border-radius:14px;padding:10px;margin:6px 0">`;
      html += dotGroupStrike(10, b, BLUE, RED);
      html += `</div>`;
      html += `<div style="display:flex;gap:10px;margin:6px 0">`;
      html += `<div style="flex:1;background:rgba(0,212,106,.12);border:2px solid rgba(0,212,106,.3);border-radius:14px;padding:10px;text-align:center">
        <div style="font-size:1.1rem;font-weight:900;color:${GREEN}">å‰© ${fromTen} ä¸ª</div>
        ${dotGroup(fromTen, GREEN)}
      </div>`;
      html += `<div style="flex:1;background:rgba(255,215,0,.1);border:2px solid rgba(255,215,0,.3);border-radius:14px;padding:10px;text-align:center">
        <div style="font-size:1.1rem;font-weight:900;color:${GOLD}">åŸæ¥ ${units} ä¸ª</div>
        ${dotGroup(units, GOLD)}
      </div>`;
      html += `</div>`;
      break;

    case 'final':
      html += label('æŠŠå‰©ä¸‹çš„ä¸¤å †ç›¸åŠ ï¼Œå°±å¾—åˆ°ç­”æ¡ˆ', 'rgba(255,255,255,.7)');
      html += `<div style="display:flex;gap:10px;margin:6px 0">`;
      html += `<div style="flex:1;text-align:center">${dotGroup(fromTen, GREEN)}</div>`;
      html += `<div style="display:flex;align-items:center;font-size:1.8rem;color:rgba(255,255,255,.4)">+</div>`;
      html += `<div style="flex:1;text-align:center">${dotGroup(units, GOLD)}</div>`;
      html += `</div>`;
      html += `<div style="background:rgba(0,212,106,.15);border:2.5px solid rgba(0,212,106,.5);border-radius:18px;padding:14px;text-align:center;margin-top:6px">        <div style="font-size:2.4rem;font-weight:900;color:${GREEN};text-shadow:0 0 20px rgba(0,212,106,.5)">          ${fromTen} + ${units} = ${a-b} âœ…        </div>      </div>`;
      break;
  }
  vis.innerHTML = `<div style="display:flex;flex-direction:column;gap:6px">${html}</div>`;
}

// poNodeLayout kept for compatibility but no longer used by tutorials
function poNodeLayout(top, branches, left, right, formula){ return ''; }

function fill(n, cls, ...args){
  return Array(n).fill(cls);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  GAME
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function startLevel(id, errMode){
  isErrPractice = !!errMode;
  curLvId = id;
  const lv = LVS[id];

  if(isErrPractice){
    // Use error questions
    const errs = P.errors.filter(e=>true); // all errors
    if(errs.length===0){ alert('æ²¡æœ‰é”™é¢˜äº†ï¼å¤ªæ£’äº†ï¼'); showScreen('map'); return; }
    // build question set (repeat if < 10)
    qs = [];
    while(qs.length<10) qs.push(...errs.map(e=>({q:e.q, a:e.correct, op:e.q.includes('+')?'+':'-', n1:0, n2:0})));
    qs = qs.slice(0,10);
  } else {
    qs = Array.from({length:10}, ()=>lv.gen());
  }

  curQ=0; sCorrect=0; sStars=0; sStreak=0; maxStreak=0; curStreak=0;
  curAns=''; gStartTime=Date.now();
  curQObj=null;

  document.getElementById('h-lv').textContent = `${lv.em} ${lv.name}`;
  document.getElementById('h-st').textContent = '0';
  document.getElementById('h-q').textContent = '1';
  document.getElementById('pb').style.width='0%';
  document.getElementById('streak').classList.remove('show');

  showScreen('game');
  ensureBgmAlive();
  loadQ();
}

function loadQ(){
  if(curQ>=qs.length){ endLevel(); return; }
  clearInterval(timerInt);
  submitting = false;   // â† æ¯é“æ–°é¢˜è§£é”
  curAns=''; updateAD();
  curQObj = qs[curQ];
  wrongTryCount = 0;

  // Determine method for hint
  const lv = LVS[curLvId];
  if(lv.method==='cou'||(lv.method==='both'&&curQObj.op==='+')) curMethodForHint='cou';
  else if(lv.method==='po'||(lv.method==='both'&&curQObj.op==='-')) curMethodForHint='po';
  else curMethodForHint=null;

  // Show/hide hint button (only for carry/borrow)
  const hb = document.getElementById('hint-btn');
  const needsHint = (curQObj.op==='+'&&curQObj.n1+curQObj.n2>10)||(curQObj.op==='-'&&curQObj.n1>10);
  hb.className = needsHint ? 'hint-inline show' : 'hint-inline';

  const qEl = document.getElementById('qd');
  qEl.style.opacity='0'; qEl.style.transform='translateY(-8px)';
  setTimeout(()=>{
    qEl.textContent = curQObj.q;
    qEl.style.transition='all .3s'; qEl.style.opacity='1'; qEl.style.transform='none';
    speak(qToSpeech(curQObj.q));
  },100);

  document.getElementById('h-q').textContent = curQ+1;
  document.getElementById('pb').style.width=(curQ/10*100)+'%';
  startTimer();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  TIMER
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function startTimer(){
  timerV=15; updateTimer();
  timerInt=setInterval(()=>{
    timerV--; updateTimer();
    if(timerV<=0){ clearInterval(timerInt); timeUp(); }
  },1000);
}
function updateTimer(){
  const c=document.getElementById('tc'), t=document.getElementById('tt');
  const pct=timerV/15, circ=125.6;
  c.style.strokeDashoffset=circ*(1-pct);
  c.style.stroke=pct>.5?'#00d46a':pct>.25?'#ffd700':'#ff4757';
  t.textContent=timerV; t.style.color=pct>.25?'#fff':'#ff8c96';
}
function timeUp(){
  if(submitting) return;
  submitting = true;
  curStreak=0;
  const q=curQObj;
  showFb(false,'â°','æ—¶é—´åˆ°äº†ï¼',`æ­£ç¡®ç­”æ¡ˆæ˜¯ ${q.a}`,'#ff4757');
  setTimeout(()=>{ dismissFb(); nextQ(false,true); },1900);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  INPUT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function ni(d){ if(curAns.length>=2) return; curAns+=d; updateAD(); pulseAD(); }
function nd(){ curAns=curAns.slice(0,-1); updateAD(); }
function updateAD(){ document.getElementById('at').textContent=curAns; }
function pulseAD(){
  const el=document.getElementById('ad');
  el.classList.remove('pulse'); void el.offsetWidth; el.classList.add('pulse');
}

function submit(){
  if(!curAns || submitting) return;   // â† åŠ é”
  submitting = true;
  clearInterval(timerInt);
  const ans=parseInt(curAns), correct=curQObj.a;

  if(ans===correct){
    const stars=timerV>=10?3:timerV>=5?2:1;
    sStars+=stars; sCorrect++; curStreak++;
    if(curStreak>maxStreak) maxStreak=curStreak;
    document.getElementById('h-st').textContent=sStars;

    if(curStreak>=3){
      document.getElementById('sk-n').textContent=curStreak;
      const sb=document.getElementById('streak');
      sb.classList.add('show');
      setTimeout(()=>sb.classList.remove('show'),2000);
    }

    const msgs=[
      ['ğŸ‰','å¤ªæ£’äº†ï¼','ä½ æ˜¯æ•°å­¦å°å¤©æ‰ï¼'],['ğŸŒŸ','å®Œç¾ï¼','å®‡å®™éƒ½åœ¨ä¸ºä½ é¼“æŒï¼'],
      ['ğŸš€','å¤ªå‰å®³äº†ï¼','ç»§ç»­å†²ï¼'],['ğŸ’¥','è¶…çº§æ£’ï¼','æ˜Ÿæ˜Ÿéƒ½ç¾¡æ…•ä½ ï¼'],
      ['âš¡','é—ªç”µå›ç­”ï¼','ä»€ä¹ˆé€Ÿåº¦ï¼'],['ğŸ¯','ç²¾å‡†å‘½ä¸­ï¼','å°±çŸ¥é“ä½ è¡Œï¼'],
    ];
    const [em,msg,sub]=msgs[Math.floor(Math.random()*msgs.length)];
    spawnParticles();
    showFb(true,em,msg,`+${stars}â­ ${sub}`,'#00d46a');
    setTimeout(()=>{ dismissFb(); nextQ(true,false); },1300);
  } else {
    curStreak=0;
    // Add to error book
    addError(curQObj.q, correct, ans, curLvId);

    const msgs=[
      ['ğŸ˜…','å·®ä¸€ç‚¹ï¼','çœ‹çœ‹æ­£ç¡®ç­”æ¡ˆï¼Œä¸‹æ¬¡ä¸€å®šè¡Œï¼'],
      ['ğŸ’ª','å†æƒ³æƒ³ï¼','æ²¡å…³ç³»ï¼Œç»§ç»­åŠ æ²¹ï¼'],
      ['ğŸ¤”','å“å‘€ï¼','æ­£ç¡®ç­”æ¡ˆåœ¨ä¸‹é¢ï½'],
    ];
    const [em,msg,sub]=msgs[Math.floor(Math.random()*msgs.length)];
    wrongTryCount++;
    if(wrongTryCount>=3){
      showFb(false,em,msg,`æ­£ç¡®ç­”æ¡ˆæ˜¯ ${correct}`,'#ff4757');
      speak(`æ­£ç¡®ç­”æ¡ˆæ˜¯ ${correct}`);
    } else {
      showFb(false,'ğŸš€',msg,'å†è¯•ä¸€æ¬¡ï¼','#ff4757');
      speak('å†è¯•ä¸€æ¬¡');
    }
    const qEl=document.getElementById('qd');
    qEl.classList.add('shake'); setTimeout(()=>qEl.classList.remove('shake'),400);
    setTimeout(()=>{ 
      dismissFb(); 
      if(wrongTryCount>=3) {
        nextQ(false,false);
      } else {
        // Let the child try again: clear previous input
        curAns='';
        updateAD();
        submitting=false;
      }
    },1900);
  }
}

function nextQ(correct, timedOut){ curQ++; curAns=''; updateAD(); loadQ(); }

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  FEEDBACK
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function showFb(ok, em, msg, sub, borderColor){
  const el=document.getElementById('fb');
  document.getElementById('fb-em').textContent=em;
  document.getElementById('fb-msg').textContent=msg;
  document.getElementById('fb-sub').textContent=sub;
  document.getElementById('fb-card').style.borderColor=borderColor;
  el.classList.add('show');
}
function dismissFb(){ document.getElementById('fb').classList.remove('show'); }

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  HINT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function showHint(){
  if(!curQObj) return;
  const hint = computeHint(curQObj);
  if(!hint){ closeHint(); return; }

  const badge = document.getElementById('hint-badge');
  badge.textContent = hint.method==='cou'?'ğŸ”µ å‡‘åæ³•':'ğŸŸ  ç ´åæ³•';
  badge.className = 'hm-badge hm-'+(hint.method);

  const qq=document.getElementById('hint-question');
  if(qq) qq.textContent = curQObj.q.replace('= ?','') + 'ï¼Ÿ';

  renderHintAnim(hint, curQObj);

  const stepsEl = document.getElementById('hint-steps');
  stepsEl.innerHTML = hint.steps.slice(0,2).map((s,i)=>`
    <div class="hint-step">
      <div class="hint-step-num" style="background:rgba(255,215,0,.18);border:1px solid rgba(255,215,0,.35);color:#fff">${i+1}</div>
      <div class="hint-step-body">
        <div class="hint-formula">${s.title}</div>
        <div class="hint-explain">${s.explain}</div>
      </div>
    </div>
  `).join('');

  document.getElementById('hint-modal').classList.add('show');
  speak(hint.openSpeak);
}

let _hintAnimTimer = null;
function renderHintAnim(hint, qObj){
  const box = document.getElementById('hint-anim');
  if(!box) return;
  if(_hintAnimTimer){ clearInterval(_hintAnimTimer); _hintAnimTimer=null; }

  const n1=qObj.n1, n2=qObj.n2, ans=qObj.a;
  const makeFrame = (aFill=0, moved=0)=>{
    let h='<div class="ten-frame" style="width:100%">';
    for(let i=0;i<10;i++){
      let cls='tf-dot';
      if(i<aFill) cls+=' a';
      if(i>=aFill && i<aFill+moved) cls+=' moved';
      h+=`<div class="${cls}"></div>`;
    }
    h+='</div>';
    return h;
  };

  if(hint.method==='cou'){
    const need = 10 - n1;
    const rest = n2 - need;

    box.innerHTML = `
      <div class="tf-wrap">
        <div style="font-weight:900;color:#fff;margin-bottom:6px">å…ˆå‡‘åï¼</div>
        <div style="display:flex;gap:10px;width:100%;align-items:flex-start">
          <div style="flex:1;background:rgba(30,144,255,.10);border:1.5px solid rgba(30,144,255,.25);border-radius:14px;padding:10px">
            <div style="font-size:.85rem;color:rgba(255,255,255,.75);text-align:center;margin-bottom:6px">å·¦è¾¹ï¼šå…ˆè£…æ»¡ 10</div>
            <div id="cou-left" class="ten-frame"></div>
          </div>
          <div style="flex:1;background:rgba(255,215,0,.10);border:1.5px solid rgba(255,215,0,.25);border-radius:14px;padding:10px">
            <div style="font-size:.85rem;color:rgba(255,255,255,.75);text-align:center;margin-bottom:6px">å³è¾¹ï¼šé»„çƒ</div>
            <div id="cou-right" class="extra-dots" style="justify-content:center"></div>
          </div>
        </div>
        <div id="cou-cap" style="font-size:.9rem;color:rgba(255,255,255,.78);text-align:center;margin-top:10px">æŠŠå³è¾¹çš„é»„çƒæŒª ${need} ä¸ªåˆ°å·¦è¾¹ç©ºæ ¼é‡Œ</div>
      </div>`;

    const left=document.getElementById('cou-left');
    const right=document.getElementById('cou-right');

    const renderLeft=(moved)=>{
      if(!left) return;
      left.innerHTML = Array(10).fill(0).map((_,i)=>{
        let cls='tf-dot';
        if(i<n1) cls+=' a';
        if(i>=n1 && i<n1+moved) cls+=' moved';
        return `<div class="${cls}"></div>`;
      }).join('');
    };
    const renderRight=(moved)=>{
      if(!right) return;
      right.innerHTML = Array(n2).fill(0).map((_,i)=> i<moved ? `<div class="ed empty"></div>` : `<div class="ed b"></div>`).join('');
    };

    let step=0;
    renderLeft(0); renderRight(0);

    _hintAnimTimer=setInterval(()=>{
      step++;
      const moved=Math.min(step, need);
      renderLeft(moved);
      renderRight(moved);
      const cap=document.getElementById('cou-cap');
      if(cap){
        cap.textContent = moved<need ? `ç»§ç»­æŒªï½ è¿˜å·® ${need-moved} ä¸ªå°±æ»¡ 10` : `å‡‘æ»¡ 10 ä»¥åè¿˜å‰© ${rest} ä¸ªï¼š10 + ${rest} = ${ans}`;
      }
      if(step>=need+2){ clearInterval(_hintAnimTimer); _hintAnimTimer=null; }
    }, 520);

  } else {
    const units = n1 % 10;
    const fromTen = 10 - n2;
    box.innerHTML = `
      <div class="tf-wrap">
        <div style="font-weight:900;color:#fff;margin-bottom:4px">å…ˆä» 10 é‡Œæ‹¿èµ°</div>
        <div style="display:flex;gap:10px;width:100%;align-items:flex-start">
          <div style="flex:1">
            <div style="font-size:.85rem;color:rgba(255,255,255,.75);text-align:center;margin-bottom:6px">10 ä¸ª</div>
            <div id="hb-ten" class="ten-frame"></div>
          </div>
          <div style="flex:1">
            <div style="font-size:.85rem;color:rgba(255,255,255,.75);text-align:center;margin-bottom:6px">æ—è¾¹è¿˜æœ‰ ${units} ä¸ª</div>
            <div class="extra-dots" id="hb-units"></div>
          </div>
        </div>
        <div id="hb-cap" style="font-size:.85rem;color:rgba(255,255,255,.75);text-align:center;margin-top:8px">ä» 10 é‡Œæ‹¿èµ° ${n2} ä¸ª</div>
      </div>`;
    const ten=document.getElementById('hb-ten');
    const u=document.getElementById('hb-units');
    if(ten) ten.innerHTML = Array(10).fill(0).map(()=>`<div class="tf-dot a"></div>`).join('');
    if(u) u.innerHTML = Array(units).fill(0).map(()=>`<div class="ed b"></div>`).join('');
    let step=0;
    _hintAnimTimer=setInterval(()=>{
      step++;
      const removed=Math.min(step, n2);
      if(ten) ten.innerHTML = Array(10).fill(0).map((_,i)=> i<removed ? `<div class="tf-dot" style="background:rgba(255,71,87,.25);border-color:rgba(255,71,87,.35)"></div>` : `<div class="tf-dot moved"></div>`).join('');
      const cap=document.getElementById('hb-cap');
      if(cap) cap.textContent = removed<n2 ? `å·²ç»æ‹¿èµ° ${removed} ä¸ª` : `10 é‡Œå‰© ${fromTen} ä¸ªï¼Œå†åŠ ä¸Š ${units} ä¸ª â†’ ${fromTen}+${units}=${ans}`;
      if(step>=n2+2){ clearInterval(_hintAnimTimer); _hintAnimTimer=null; }
    }, 520);
  }
}

function computeHint(qObj){
  const {op, n1, n2, a} = qObj;
  if(op==='+'&&n1+n2>10){
    const need=10-n1, rest=n2-need;
    return { method:'cou',
      openSpeak:`å…ˆå‡‘åï¼æŠŠé»„çƒæ¬è¿‡å»è£…æ»¡ 10ï¼Œå†åŠ å‰©ä¸‹çš„ï¼`,
      steps:[
        {title:`å…ˆå‡‘åï¼`, explain:`æŠŠå³è¾¹çš„é»„çƒæŒª ${need} ä¸ªåˆ°å·¦è¾¹ç©ºæ ¼é‡Œã€‚`},
        {title:`å‡‘æ»¡ 10 ä»¥åè¿˜å‰© ${rest} ä¸ª`, explain:`æ‰€ä»¥ 10 + ${rest} = ${a}ã€‚`},
      ]
    };
  }
  if(op==='-'&&n1>10){
    const units=n1%10, fromTen=10-n2;
    return { method:'po',
      openSpeak:`ç”¨ç ´åæ³•ï¼æŠŠ ${n1} åˆ†æˆ 10 å’Œ ${units}ï¼Œå…ˆä» 10 é‡Œå‡æ‰ ${n2}ã€‚`,
      steps:[
        {title:`å…ˆåˆ†å¼€ï¼š${n1} = 10 + ${units}`, explain:`å…ˆæŠŠæ•°æ‹†å¼€ã€‚`},
        {title:`å…ˆä»10é‡Œæ‹¿èµ°ï¼š${n2} ä¸ª`, explain:`ä» 10 é‡Œæ‹¿èµ° ${n2} ä¸ªã€‚`},
        {title:`å†åˆèµ·æ¥`, explain:`10 é‡Œå‰© ${fromTen} ä¸ªï¼Œå†åŠ æ—è¾¹ ${units} ä¸ªã€‚`},
      ]
    };
  }
  return null;
}

function closeHint(){ document.getElementById('hint-modal').classList.remove('show'); }

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  END LEVEL
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function endLevel(){
  clearInterval(timerInt);
  document.getElementById('hint-btn').className='';
  const lv = LVS[curLvId];
  const elapsed=Math.round((Date.now()-gStartTime)/1000);
  const passed=sCorrect>=lv.pass;

  let starsEarned=0;
  if(sCorrect>=lv.pass) starsEarned=1;
  if(sCorrect>=9) starsEarned=2;
  if(sCorrect===10) starsEarned=3;

  const prev=P.stars[curLvId]||0;
  if(starsEarned>prev) P.stars[curLvId]=starsEarned;

  // Unlock next node in MAP_PATH
  if(passed){
    if(curLvId === 0 && !P.unlocked.includes(1))  P.unlocked.push(1);
    // levels 1 and 2 gate to tutorials (tutorial done â†’ unlocks level, handled by completeTutorial)
    // level 3 â†’ level 4 direct
    if(curLvId === 3 && !P.unlocked.includes(4))  P.unlocked.push(4);
    // level 4 no next
  }

  // Save session
  P.sessions.unshift({lvId:curLvId,lvName:lv.name,date:new Date().toLocaleDateString('zh-CN'),
    correct:sCorrect,total:10,stars:sStars,elapsed});
  if(P.sessions.length>30) P.sessions.pop();
  save();

  if(passed&&!isErrPractice) showCelebration(lv, starsEarned, elapsed);
  else showResult(lv, starsEarned, elapsed, passed);
}

function showResult(lv, starsE, elapsed, passed){
  document.getElementById('res-em').textContent = passed?'ğŸ‰':'ğŸ’ª';
  document.getElementById('res-title').textContent = passed?`${lv.name}é€šå…³ï¼`:'ç»§ç»­åŠ æ²¹ï¼';
  document.getElementById('res-stars').innerHTML = 'â­â˜†â˜†'.split('').map((c,i)=>`<span>${i<starsE?'â­':'â˜†'}</span>`).join('');
  document.getElementById('rr-cor').textContent = sCorrect+'/10';
  document.getElementById('rr-st').textContent = sStars;
  document.getElementById('rr-sk').textContent = maxStreak;
  document.getElementById('rr-t').textContent = elapsed+'s';

  const nextBtn=document.getElementById('res-next');
  // determine what comes after this level
  const nextIsGated = (curLvId===1 && !P.tutsDone.includes('cou'))
                   || (curLvId===2 && !P.tutsDone.includes('po'));
  if(!isErrPractice && passed){
    nextBtn.style.display='';
    if(nextIsGated){
      const tutId = curLvId===1?'cou':'po';
      const tutName = tutId==='cou'?'ğŸ”µ å­¦å‡‘åæ³•':'ğŸŸ  å­¦ç ´åæ³•';
      nextBtn.textContent = `${tutName} â†’`;
      nextBtn.onclick = ()=>startTutorial(tutId);
      document.getElementById('res-msg').textContent='ğŸ‰ è§£é”æ–°æ•™ç¨‹ï¼å…ˆå­¦æ–¹æ³•ï¼Œå†å»æŒ‘æˆ˜ï¼';
    } else if(curLvId+1<LVS.length && P.unlocked.includes(curLvId+1)){
      nextBtn.textContent = 'ä¸‹ä¸€å…³ â†’';
      nextBtn.onclick = ()=>nextLevel();
      document.getElementById('res-msg').textContent='å¯ä»¥å»æŒ‘æˆ˜ä¸‹ä¸€é¢—æ˜Ÿçƒäº†ï¼';
    } else {
      nextBtn.style.display='none';
      document.getElementById('res-msg').textContent='å¤ªæ£’äº†ï¼åœ°å›¾ä¸Šçœ‹çœ‹æ¥ä¸‹æ¥è¦åšä»€ä¹ˆï¼';
    }
  } else if(isErrPractice){
    nextBtn.style.display='none'; document.getElementById('res-msg').textContent='é”™é¢˜ç»ƒä¹ å®Œæˆï¼ç»§ç»­åŠ æ²¹å§ï¼';
  } else {
    nextBtn.style.display='none';
    document.getElementById('res-msg').textContent=`ç­”å¯¹${LVS[curLvId].pass}é¢˜æ‰èƒ½è¿‡å…³ï¼Œå†æŒ‘æˆ˜ä¸€æ¬¡ï¼`;
  }
  showScreen('result');
}

function showCelebration(lv, starsE, elapsed){
  const cel=document.getElementById('cel');
  document.getElementById('cel-t').textContent=`${lv.em} ${lv.name}é€šå…³ï¼`;
  document.getElementById('cel-s').textContent='â­'.repeat(starsE)+'â˜†'.repeat(3-starsE);
  document.getElementById('cel-sub').textContent=`ç­”å¯¹ ${sCorrect}/10 é¢˜ï¼Œè·å¾— ${sStars} é¢—æ˜Ÿæ˜Ÿï¼`;
  const colors=['#ffd700','#ff7b00','#00d46a','#1e90ff','#c77dff','#ff4757'];
  for(let i=0;i<55;i++) setTimeout(()=>{
    const c=document.createElement('div');
    c.className='confetti';
    c.style.cssText=`left:${Math.random()*100}vw;top:-10px;background:${colors[Math.floor(Math.random()*colors.length)]};--d:${1.5+Math.random()*2}s;transform:rotate(${Math.random()*360}deg);width:${6+Math.random()*8}px;height:${6+Math.random()*8}px;border-radius:${Math.random()>.5?'50%':'2px'}`;
    document.body.appendChild(c);
    setTimeout(()=>c.remove(),4000);
  },i*60);
  cel.classList.add('show');
  speak('å¤ªæ£’äº†ï¼é€šå…³æˆåŠŸï¼');
}

function endCel(){
  document.getElementById('cel').classList.remove('show');
  showResult(LVS[curLvId], P.stars[curLvId]||0, Math.round((Date.now()-gStartTime)/1000), true);
}

function nextLevel(){ if(curLvId+1<LVS.length) startLevel(curLvId+1); }
function retryLevel(){ startLevel(curLvId); }

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  PARTICLES
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function spawnParticles(){
  const ems=['â­','âœ¨','ğŸŒŸ','ğŸ’«','ğŸ‰','ğŸŠ'];
  for(let i=0;i<8;i++) setTimeout(()=>{
    const p=document.createElement('div');
    p.className='particle';
    p.textContent=ems[Math.floor(Math.random()*ems.length)];
    p.style.left=(20+Math.random()*60)+'vw';
    p.style.top=(40+Math.random()*20)+'vh';
    p.style.setProperty('--d',(0.7+Math.random()*.6)+'s');
    document.body.appendChild(p);
    setTimeout(()=>p.remove(),1400);
  },i*60);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  ERROR BOOK
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function addError(q, correct, userAns, lvId){
  // Remove duplicates of same question
  P.errors = P.errors.filter(e=>e.q!==q);
  P.errors.unshift({q, correct, userAns, lvId, lvName:LVS[lvId].name, date:new Date().toLocaleDateString('zh-CN')});
  if(P.errors.length>50) P.errors.pop();
  save();
}
function clearErrors(){ P.errors=[]; save(); }

function renderErrorBook(){
  const errs=P.errors;
  document.getElementById('err-count').textContent=`å…± ${errs.length} é“é”™é¢˜`;
  document.getElementById('err-practice-btn').style.display=errs.length?'':'none';
  const list=document.getElementById('err-list');
  if(errs.length===0){
    list.innerHTML=`<div class="err-empty">ğŸŒŸ å¤ªæ£’äº†ï¼<br>ç°åœ¨æ²¡æœ‰é”™é¢˜ï¼<br>ç»§ç»­ä¿æŒï¼</div>`;
    return;
  }
  list.innerHTML=errs.map((e,i)=>`
    <div class="err-item">
      <div class="ei-q">${e.q}</div>
      <div>
        <div class="ei-ans">ç­”äº†${e.userAns}ï¼Œåº”æ˜¯${e.correct}</div>
        <div class="ei-lv">${e.lvName} Â· ${e.date}</div>
      </div>
    </div>
  `).join('');
}

function startErrorPractice(){
  if(P.errors.length===0){ alert('æ²¡æœ‰é”™é¢˜äº†ï¼å¤ªæ£’äº†ï¼'); return; }
  // Start a practice session using error questions
  isErrPractice=true;
  curLvId=0; // use level 0 as base
  const errs=P.errors;
  qs=[];
  while(qs.length<10) qs.push(...errs.map(e=>({q:e.q,a:e.correct,op:e.q.includes('+')?'+':'-',
    n1:parseInt(e.q.split(/[+\-]/)[0].trim()),n2:parseInt(e.q.split(/[+\-]/)[1])})));
  qs=qs.slice(0,10);
  // Shuffle
  for(let i=qs.length-1;i>0;i--){const j=Math.floor(Math.random()*(i+1));[qs[i],qs[j]]=[qs[j],qs[i]];}
  curQ=0; sCorrect=0; sStars=0; sStreak=0; maxStreak=0; curStreak=0;
  curAns=''; gStartTime=Date.now();
  document.getElementById('h-lv').textContent='ğŸ“’ é”™é¢˜ç»ƒä¹ ';
  document.getElementById('h-st').textContent='0';
  document.getElementById('h-q').textContent='1';
  document.getElementById('pb').style.width='0%';
  showScreen('game');
  ensureBgmAlive();
  loadQ();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  PARENT PANEL
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderParent(){
  switchTab('overview');
}

function switchTab(name){
  ['overview','levels','history'].forEach(t=>{
    document.getElementById('tab-'+t).className='tab'+(t===name?' on':'');
    document.getElementById('ps-'+t).className='p-section'+(t===name?' on':'');
  });
  if(name==='overview') renderPOverview();
  if(name==='levels') renderPLevels();
  if(name==='history') renderPHistory();
}

function renderPOverview(){
  // Stats
  const totalStars=Object.values(P.stars).reduce((a,b)=>a+b,0);
  const totalSessions=P.sessions.length;
  const totalErrors=P.errors.length;
  const totalCorrect=P.sessions.reduce((a,s)=>a+s.correct,0);
  const totalQs=P.sessions.reduce((a,s)=>a+s.total,0);
  const acc=totalQs?Math.round(totalCorrect/totalQs*100):0;
  const levelsCleared=Object.keys(P.stars).length;

  document.getElementById('p-stat-grid').innerHTML=`
    <div class="p-stat"><div class="p-stat-n">${totalStars}</div><div class="p-stat-l">â­ æ€»æ˜Ÿæ˜Ÿ</div></div>
    <div class="p-stat"><div class="p-stat-n">${levelsCleared}</div><div class="p-stat-l">ğŸª å·²é€šå…³</div></div>
    <div class="p-stat"><div class="p-stat-n">${acc}%</div><div class="p-stat-l">âœ… æ€»æ­£ç¡®ç‡</div></div>
    <div class="p-stat"><div class="p-stat-n">${totalSessions}</div><div class="p-stat-l">ğŸ® ç»ƒä¹ æ¬¡æ•°</div></div>
    <div class="p-stat"><div class="p-stat-n">${totalErrors}</div><div class="p-stat-l">ğŸ“’ é”™é¢˜æ•°</div></div>
    <div class="p-stat"><div class="p-stat-n">${totalCorrect}</div><div class="p-stat-l">ğŸ’¡ ç­”å¯¹é¢˜æ•°</div></div>
  `;

  // Accuracy bars
  const bars=document.getElementById('p-acc-bars');
  bars.innerHTML=LVS.map(lv=>{
    const lvSessions=P.sessions.filter(s=>s.lvId===lv.id);
    const lvCorrect=lvSessions.reduce((a,s)=>a+s.correct,0);
    const lvTotal=lvSessions.reduce((a,s)=>a+s.total,0);
    const lvAcc=lvTotal?Math.round(lvCorrect/lvTotal*100):0;
    return `<div class="p-bar-row">
      <div class="p-bar-lbl">${lv.em} ${lv.name}</div>
      <div class="p-bar-track"><div class="p-bar-fill" style="width:${lvAcc}%"></div></div>
      <div class="p-bar-val">${lvTotal?lvAcc+'%':'--'}</div>
    </div>`;
  }).join('');

  // Error summary
  const errByLv={};
  P.errors.forEach(e=>{ errByLv[e.lvName]=(errByLv[e.lvName]||0)+1; });
  const errSummary=document.getElementById('p-error-summary');
  if(P.errors.length===0){
    errSummary.innerHTML='<div style="text-align:center;color:var(--green);padding:10px">ğŸŒŸ ç›®å‰æ²¡æœ‰é”™é¢˜ï¼Œæ£’æäº†ï¼</div>';
  } else {
    const top=P.errors.slice(0,5);
    errSummary.innerHTML=`
      <div style="font-size:.9rem;color:var(--gold);margin-bottom:8px;font-weight:900">ğŸ“’ æœ€è¿‘é”™é¢˜ (å…±${P.errors.length}é¢˜)</div>
      ${top.map(e=>`<div style="font-size:.88rem;color:var(--dim);padding:4px 0;border-bottom:1px solid var(--border)">${e.q} <span style="color:#ff8c96">â†’ ç­”äº†${e.userAns}ï¼Œåº”æ˜¯${e.correct}</span></div>`).join('')}
    `;
  }
}

function renderPLevels(){
  const el=document.getElementById('p-levels-detail');
  el.innerHTML=LVS.map(lv=>{
    const lvS=P.sessions.filter(s=>s.lvId===lv.id);
    const total=lvS.reduce((a,s)=>a+s.total,0);
    const correct=lvS.reduce((a,s)=>a+s.correct,0);
    const acc=total?Math.round(correct/total*100):null;
    const best=lvS.length?Math.max(...lvS.map(s=>s.correct)):null;
    const stars=P.stars[lv.id]||0;
    return `<div class="p-session" style="flex-direction:column;align-items:flex-start;gap:6px;margin-bottom:8px">
      <div style="display:flex;justify-content:space-between;width:100%">
        <div style="font-size:1rem;color:#fff;font-weight:700">${lv.em} ${lv.name}</div>
        <div style="color:var(--gold)">${'â­'.repeat(stars)}${'â˜†'.repeat(3-stars)}</div>
      </div>
      <div style="font-size:.8rem;color:var(--dim);display:flex;gap:16px">
        <span>ç»ƒäº†${lvS.length}æ¬¡</span>
        ${acc!==null?`<span>æ­£ç¡®ç‡${acc}%</span>`:'<span>è¿˜æœªç»ƒä¹ </span>'}
        ${best!==null?`<span>æœ€é«˜${best}/10é¢˜</span>`:''}
      </div>
    </div>`;
  }).join('');
}

function renderPHistory(){
  const el=document.getElementById('p-history-list');
  if(P.sessions.length===0){
    el.innerHTML='<div style="text-align:center;color:var(--dim);padding:20px">è¿˜æ²¡æœ‰ç»ƒä¹ è®°å½•</div>';
    return;
  }
  el.innerHTML=P.sessions.map(s=>`
    <div class="p-session">
      <div>
        <div class="ps-lv">${LVS[s.lvId]?.em||'ğŸ“’'} ${s.lvName}</div>
        <div class="ps-date">${s.date} Â· ${s.elapsed}ç§’</div>
      </div>
      <div style="text-align:right">
        <div class="ps-acc">${s.correct}/10 âœ…</div>
        <div style="font-size:.8rem;color:var(--gold)">â­${s.stars}</div>
      </div>
    </div>
  `).join('');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  KEYBOARD
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
document.addEventListener('keydown',e=>{
  if(document.getElementById('screen-game').classList.contains('active')){
    if(e.key>='0'&&e.key<='9') ni(e.key);
    if(e.key==='Backspace') nd();
    if(e.key==='Enter') submit();
  }
});

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  STARFIELD
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function initStars(){
  const sf=document.getElementById('sf');
  for(let i=0;i<120;i++){
    const s=document.createElement('div'); s.className='star';
    const sz=Math.random()*2.5+.5;
    s.style.cssText=`width:${sz}px;height:${sz}px;left:${Math.random()*100}%;top:${Math.random()*100}%;--d:${2+Math.random()*4}s;animation-delay:${Math.random()*4}s`;
    sf.appendChild(s);
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  UTIL
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function r(min,max){ return Math.floor(Math.random()*(max-min+1))+min; }

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  INIT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
initStars();

// Start BGM on first user interaction (browser autoplay policy)
function startBgmOnInteraction(){
  initBgm();
  document.removeEventListener('click', startBgmOnInteraction);
  document.removeEventListener('touchstart', startBgmOnInteraction);
}
document.addEventListener('click', startBgmOnInteraction);
document.addEventListener('touchstart', startBgmOnInteraction);
</script>
</body>
</html>
